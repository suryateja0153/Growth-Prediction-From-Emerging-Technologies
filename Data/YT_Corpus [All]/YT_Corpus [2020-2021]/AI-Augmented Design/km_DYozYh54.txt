 the 2016 release servile Interactive's hitman brought the franchise back to its ruse of creating rich and interesting scenarios in which agent 47 needs to eliminate his targets often in improvised an impractical ways to achieve this the game has a myriad of AI systems under the hood and that's what we're here to explore I'm Tommy Thompson and welcome to AI in games a series on research and applications of artificial intelligence in video games in this episode we're going to deep dive into the suite of AI systems built to support the current generation of hitman creating responsive non player characters bodyguards crowd systems a I driven animation and more as players once again become the sandbox assassin [Applause] [Music] man is a series about well being a hitman killing a bunch of typically horrible and unscrupulous individuals that the world won't really mess but for each player it's more about the unique stories that they can craft for themselves as you eliminate targets in nail-biting or assembly hilarious ways hitman is laced with systems enable you to experiment improvise and react to changes in the larger story that's playing out and the progression being made towards eliminating your target poison drinks as a barman snap necks as a masseur scare someone as a plague doctor even gain the trust of a recording team by playing the drums the game provides a range of fun and often bespoke methods to Zone in and remove your quarry an increasingly more complicated and expansive scenarios whether you're walking the catwalk of Paris Fashion Week - sneaking through political upheaval in Marrakech your targets are found in dense lively and complicated environments with personal security local law enforcement not to mention the general public proving to be an obstacle but this is where the game really becomes interesting as players can blend into their surroundings assume disguises and manipulate the world around them all in an effort to get one step closer to the target deliver some karmic retribution and subsequently escape as everyone around them is simply unaware of their presence at man is at it's more satisfying when you're preparation and planning come to a head and are executed perfectly and it requires numerous AI systems to pull off and build that fantasy in this video we're going to focus on four key systems how they work and what they do to help support the Hitman experienced a situation driven behavior tree system where over 300 characters in a given level can make decisions about what to do based upon what they know is happening around them react to circumstances and often play directly into the players hands a responsive and pragmatic bodyguard and security system for ensuring targets become all that more difficult to reach and will be rushed to secure defensive locations in the event they become compromised powerful crowd behavior management and simulation system that enables for over one thousand crowd characters to be active in a given level but can still react to actions the player executes and lastly a finely tuned animation framework that ensures all of these characters look and behave as realistic as possible now I'm going to explain how all of this works as well as some of the finer design tweaks adopted for both the 2016 release as well as the 2018 sequel however in order for me to talk about the AI of either game I need to take a look at where the current AI toolchain started and the core principles of its design were initially formed and to do that I'm gonna take a look at hitman absolution released in 2012 hitman absolution was a more streamlined and linear interpretation of the franchise's formula that while not as critically acclaimed as the more recent releases is the basis of the core technology and tools used in both the 2016 and 2018 games one of the big reasons for this as the absolution was the first entry in the franchise since 2006 is hitman blood money given the intermittent years IO Interactive were spent on the Kane and Lynch titles as well as many ninjas hence absolution was building new tools and systems that bear reflected the team's ambitions for the coming years the core architecture of hitman 2016's non-player character AI as well as the systems for codes and animation were all originally built in absolution then embellished upon in the 2016 reboot and in hitman 2 so let's go take a look the core AI architecture is built to cater to the variety of play styles that hitman absolution and subsequent games have afforded this means the system supports you're approaching using stealth tactics wearing disguises and blending in tiered environments referred to as social stealth but the developers are taking a more aggressive approach and just going in guns blazing pen addition it's built to have non player characters living their lives as expected often with some sort of established routines of behaviors they are serving drinks applying makeup guarding entryways cooking dinner whatever is needed to fit the fiction of the location these routines need to be predictable and reliable given players rely on this sort of predictable and stealth games but can be interrupted as they investigate the many many many items and objects that players can manipulate in the world whether you're turning off a motor causing a sink to overflow puncturing a fuel tank or playing a video tape depending on the type of interaction it will either draw characters to them with immediate effect given they interrupt the character's activity or will inject a more delayed interruption to specific character routines such that they will come and see what you're doing sooner rather than later this is useful for some of the more specific actions that lure targets into locations given you don't want to have to wait 20 minutes for the payoff but at the same time if they run over immediately after you triggered the action it will seem stilted and forced yet man's core AI is reliant on behavior trees arguably the most common format for modern game AI behavior management as mentioned in my AI 101 episode on behaviour trees they take a top-down approach to structuring behavior and how characters respond to specific circumstances with behaviors selected often due to specific conditions in the world and resulting in single or multi action sequences as they respond to what the player and other game systems are doing if you want to know more about how behavior trees work go and watch that video so before the behavior tree in hitman can make a decision each character has to know what's happening in the world around them to do that each active AI character in the world has a knowledge base a knowledge base is comprised of two sets of data public knowledge which is information that is shared about a given item or character as well as information that reflects its current state but also there's private knowledge that our character will maintain about last known positions of objects and retains a history of knowledge about specific items hence a character will notice when items and their proximity go missing or are tampered with and similarly won't keep trying to find or interact with characters that are either missing or dead the knowledge base is accumulated by taking all the information happening in the game at that point in time and distilling it down via both sensors and services sensors allow characters to update their private knowledge and react to changes as they see and hear things in local products meanwhile services update the shared knowledge base three of the most common services of the disguise dead body and hetman services the disguised service is used when agent 47 is wearing a costume and it helps characters to know whether that outfit will look suspicious to them or not meanwhile the dead body service helps characters and local proximity understand a dead body has been found nearby and how to adjust accordingly lastly the Hitman service allows for common knowledge of agent 47 to be shared such as whether the player is compromised and where in the world they were last spotted what's fun about the sensors and services is that they provide this interesting balance of contextual knowledge but also leave gaps for players to exploit the sensors provide immediate information about the world that can be interrupted by braking lane of sight or distracting the character meanwhile services are not omnipotent and only update periodically hence a lot of information from the services can become out-of-date pretty quickly and that leaves scope for the player to manipulate characters to suit their needs but now that the AI has all of this information it needs to make decisions about how to react each AI character can enable one of a set of goals that drive the decisions that are bout to make with these goals selected it will then use the behavior tree to make a decision about how to behave next I still haven't explained that part yet but I'm getting to it to diversify the gameplay the game breaks down AI driven non player characters into two main types civilians and guards in each instance the NPC type impacts the information stored in their knowledge base and the types of goals they can assign themselves first up they're civilians these characters are typically passive in nature but will spot more extreme behaviors as suspicious or alarming they can activate goals such as confronting the player and alerting guards but civilians aren't allowed to go into combat two great examples of this can be seen in the Paris Fashion Show level and the Bangkok Hotel level in the 2016 hitman where civilians with different knowledge base profiles result in different behavior the guests are a lot more passive but will react to your behavior if it becomes too excessive while staff and the entourage surrounding your targets are much more likely to react to your shenanigans and confront you secondly there are guards these are naturally the players main adversary and will engage in combat with you as well as respond to the more extreme circumstances such as the discovery of dead or unconscious bodies as well as weapons and other sensitive objects being found lying out in the open world as mentioned already hitman 2016 introduces bodyguard AI that actively follow and guard a VIP as they move around an environment while still leaving them free to explore the world themselves this requires an entirely separate system to operate and I'll explain that later in the video now given all this information and the goals that have been activated the behavior tree system is built to have characters do one of two things they either execute behaviors on their own or they join a situation where specific behaviors are coordinated by a group a behavior is one or more actions ranging from turning to the player to interact or talk with them moving to locations in the world entering combat or interacting with objects the player may of manipulated you'll notice play in the game that a lot of the targets will execute specific behaviors once the player has manipulated the world in a particular way this is because it aligns with specific goals the target should complete once certain conditions are met which effectively means that they deliberately put themselves in precarious positions for you to go kill them which is just kind of hilarious and messed up when you think about it meanwhile situations often arise when events occur in the world that have a larger impact such as when dead bodies are discovered the player is compromised or the target has realized they're under attack and tried to flee in these cases characters will recognize what's happening around them and join a situation meanwhile the situation dictates who does war and they all play their part in establishing the fiction so for example in the event you open fire on the crowd at the Fashion Show the guests and staff will often flee and call for help while the guards will hunt you down and open fire but all of this is being governed by the same situation the behavior tree system was first devised an absolution and has since been heavily optimized and improved for both the 2016 and 2018 releases it utilizes a level of detail or lauding system meaning that while there can be over 300 active behavior tree driven AI in a given level the ones farthest away from the player update their behavior less frequently as the cpu resource used for updating AI prioritizes those closest to Year in addition the animations of these distant AI are either dialed down and quality or turned off entirely as mentioned already the vast majority of the characters you see are in fact controlled by the crowd a AI system but if necessary any character in a crowd can depending on the current situation in the game be possessed by a behavior tree AI effectively upgrading them to a fully responsive and coordinated character now before we get into the bespoke systems built for the 2016 release let stack or the second core system built into absolution the croud AI framework when first bill in 2012 that could support up to 1200 agents in a single crowd with up to 500 of them visible at the same time it's not something I've talked about before on the show but crowed systems are really difficult to get Rea crowds are often comprised of lots of dummy AI that's nowhere near as smart as your more regular contemporaries a big reason for that is that there's just so many of them but also it makes sense given they're often just adhering to a crowd mentality moving through a convoluted space to their ultimate destination but in hitman the goal was to try and blur the line between the crowds and the behavior tree AI as much as possible characters and crowds are placed either as individuals that are able to walk around potentially stop and acknowledge things in the space but there are also groups that designers have a lot more control over a group is really useful if you have a particular activity you want a bunch of characters doing in a crowd such as looking at a point of interest but also standing in a larger shape or figuration each individual character runs a system that's akin to a simple finite state machine with only three main states of behavior standing idle walking and what's called pending walk this is useful in situations but a character wants to be moving but the congestion of the crowd has stopped them so well they're stuck in the crowd they're making decisions about better direction they can take and waiting for an opportunity in the crowd that will enable them to transition back to the walk state this is actually a lot more complicated than I'm making it out to be given the characters need to be able to tweak their walking speeds as they move around hence each character is able to set preferred and Max speeds and this is used to help keep the flow of the crowd moving and is even more relevant when a panic breaks out and people are running around everywhere now one of the real risks of having this many agents and a crowd system is them palling and navigation mesh for paths to take or even checking the validity have been able to reach a given destination navigation meshes are what are typically used in 3d games to enable characters to move around environments if you want to know more about how they work go watch my AI 101 episode on the topic I will realize that this was a pretty critical bottleneck and as a result there's a 2d reasoning grid that sits atop the navigation mesh that tells an AI character whether a given space is walkable whether it should be avoided given its a security region as well as exit points for NPCs and areas that are cordoned off given a panic has broken out in the crowd this often occurs because agent 47 is causing trouble and it would break the immersion of the character just waltz through it both the crowd and behavior tree AI have their own reasoning grids with the latter providing a fast and effective means to conduct site tests find valid locations near points of interest and identify tactical locations relative to a given character all without overloading the navmesh yourself but the real challenges come when you introduce agent 47 into the mix given the crowd is going to be moving around and doing their own thing but when the player starts causing trouble then the AI systems need to be able to react in kind characters immediately around the player should look panicked and potentially flee but this should have a cumulative effect across the crowd and force movement across the space as everyone in proximity begins to run from the source of the commotion this is addressed using two systems called behavior zones and panic floors so first off any action in the world that should influence the crowd creates one or more behavior zones on the reasoning grid a behavior zone sends out a pulse within a certain radius and angle relative to the source of the event that dictates how every crow di that interacts with it should respond hence if fireworks are going off then all characters within a certain radius will turn to face the point of interest to watch them explored meanwhile if the player pulls out a gun and aims at an innocent bystander this actually says of three behavior zones one that makes those in the line of fire panic and go prone one that makes characters an immediate proximity of the player panic and back off and lastly everyone within a certain range of the player becomes aware of the situation and enters a heightened state of alertness as you move around the space with the gun drawn these behaviors Owens will continue to pulse out from the player and force other crowd AI you're moving towards to begin to react there are a variety of responses a crow di can be told to execute by a behavior zone either looking at a point of interest avoiding the source of the zone being alerted to being scared by or going prone in the event a crow di is caught in between multiple behaviors Owen's they always give priority to the action that will impact their mood the most also according to my research they never come down once you set them off so if you upset a character you can only meet them worse and never really improve the situation you're just a really negative influence on people these behaviour zones are tweaked by designers on a per level basis given the design to have characters react to events happening in the world but they need to make sense in context of where you are hence for example if a fight breaks out say in the bar at the Fashion Week in Hitman 2016 that's going to seem out of place and the crowd will react to it quite negatively meanwhile if you kick off trouble in the Vixen club in hitman absolution it's not treated as seriously because well men are pegs and strip bars are not exactly renowned for being classy institutions but know that you've caused a ruckus the crowd wants to get the hell are your way and that's where the panic floors kick in panic floors are built on the reasoning grid that I mentioned earlier where each exit once placed by designers has each cell in the map calculate the shortest path to all exits using a variation of Dijkstra's algorithm these paths toward each exit are the panic floors and a crowd a I will select the best flow to follow in the event of an emergency these floors are calculated for all exits in a given space allowing for the cloudy I to dynamically shift to another exit in the event as a bottleneck but it also helps address situations where the player decides to block the nearest exit with the behavior tree AI and crow di systems being improved on for hitman 2016 there was still one major feature to be introduced the VIP and bodyguard system many of the high-value targets in hitman have an entourage of one or more bodyguards that add an extra layer of frustration for players to overcome sure each level is designed such that you can find ways around them often by having them move into compromising positions or by wearing costumes allow you to slip past unnoticed but in order to add this new layer of complexity it required an entirely new system to be built into the established AI framework the real design problem that needed to be addressed here was that bodyguards need to have a relationship to the VIP right now AI characters don't really know that each other exists the CRO di only knows that something is blocking their movement in the world while the behavior tree AI never really knows what other characters are doing as mentioned earlier the situation system is used to make them appear coordinated and react to things happening in the world but they're not willingly joining other characters to be part of that situation nor are they communicating with each other given they rely on their sensors and services to make decisions they simply make themselves available to be added to a situation and a separate system as selecting them based on their local position and other criteria but in this instance you need to have that relationship between the two AI characters bodyguards should always be following the VIP and check in on them if they've not been seen for a while given that's their job meanwhile a lot of the systemic responses to gameplay systems shouldn't be handled by the VIP given their you know a very important person and instead command their bodyguards to do it for them this required entirely new situations for escorting and evacuating VIPs to be built into the main AI system but it has very specific design rules that dictate how it should work together running IO designed to special character types VIPs are a variant of the civilian AI who react to situations slightly differently including a new ability to tell other people what to meanwhile the bodyguards are a variant of the guard AI that run a slightly modified behavior set and actively pay attention to their assigned VIP first up the system enables a situation known as ambient VIP escort where bodyguards will follow a VIP around the environment the bodyguards used the navmesh & pathfinding systems to keep within proximity and follow the character around the space in the event the VIP decides to stop then the bodyguards default to idle behaviors and wait until they need to follow again however this means the VIPs can't get any peace and quiet naturally a VIP might want to be left alone to conduct business which also helps you as the player given it would leave the target open for you to do your dirty work hence VIPs can tell bodyguards not to follow them into certain locations and level designers leave mark up on the map that tells bodyguards where to stand in the event they need to way around but this exposes a new vulnerability in the VIP could become lost or the bodyguards just stand around and never bother to check their boss is still alive that can it defeats that purpose so another situation the escorts search behavior was added to the game in the event the game recognizes the VIP cannot continue their patrolling around the map because they've been held up or they're unconscious or most likely dead then it kicks off a timer once it reaches a certain limit the closest guard will investigate the last-known position of the VIP and in the event they don't find them other bodyguards well join in and fan out the search to a larger pool of nearby locations often playing audio to signify that they are trying to find their boss in the event they find the VIP and everything is fine then things resume is normal if the VIP is dead then an active search for the player kicks in but if the VIP is found unconscious then they execute the evacuate VIP situation the last new behavior added for the 2016 game the evacuation situation is built to have bodyguards move VIPs into safe locations it can be triggered either by the VIP becoming aware of an attempt on their life gunfire explosions and any other alarms that can be triggered in proximity and evacuate situation as nearby guards form up around the VIP with the group then moving to a safe room safe rooms are locations marked up by designers to be a good location for the VIP to hide out when a group is going to move towards a safe room then the system calculates a threat and fluent space over the reasoning grid preferring paths that have the least amount of congestion which is practical given you don't want crowds to cause a bottleneck the paths calculated are deliberately built so they avoid hugging corners given we've got numerous bodyguards all protecting the same VIP so it doesn't want to have them bunch up and walk into each other in the event no safe room can be found or a path can be built the instead opted to move towards the best evacuation route that's available as a holding position until a new opportunity presents itself in any case the guards form up on the VIP to initiate the evacuation this requires them to a sumo formation there is a separate formation system that assigns characters to specific slots and prioritizes the order in which they join up followed by another system that maintains movement speeds and keeps the formation in place as best it can using the VIP as the anchor point however in the event the player is giving chase bodyguards can break off from the formation in order to stick around and fight on arrival to the safe location all guards assigned to the situation then fan out and execute a defensive behavior to keep the VIP protected if the player then turns up and compromises the safe room then the system will cause the evacuation to kick off again with NPCs forming up once more and a new room and evacuation path being calculated the last major AI component of hitman is one that players typically see the most the animation system animation in games is critical and telegraphing the decisions being made by a given character and this is even more critical when working in stealth games where the player needs to be able to see what they're thinking but at least an approximation of it given that will influence your overall strategy traditionally animation is handled by a controller whereby the system knows that in certain contexts occurred two transitions from say an idle to walking and running this typically requires program animators to build these systems not only so each character knows which animation it should be executing but how to transition between animations smoothly as well as deal with the myriad of circumstances where you need to blend multiple animations together in order to achieve a specific desired effect if it doesn't work the characters look stilted and awkward but getting it for each character is a lot of work and only becomes increasingly more complicated as characters can find themselves in more unique circumstances and as more animations are added to the system this is an issue edge software resolved by building an AI driven animation controller in Doom 2016 that minimize the number of animations made for each character and then calculated how best to manage them depending on the current context but the thing that's unique for hitman is the IO Interactive can't afford to have over a thousand complex animation controllers active in a scene at once so it needs something cheaper and ideally calculated in advance to minimize the CPU overhead as a result iowans right have explored an approach referred to as motion graphs where the goal was for the designers to plug all of their animations into the system and then it just figures out how the heck they should blend together the idea behind er is pretty straightforward if we have all these animations recorded instead of having humans in figure out how they should switch between one another an algorithm finds the frames where two animations are similar enough that it acts as a transition point between them this is achieved by finding a pair of frames one in each animation where the difference between them is as small as possible this is achieved not by finding frames and these animations are similar to one another but instead by finding the pair that are the least dissimilar once factoring and speed and direction once the dissimilarity matrix appear with the lowest value they adds them to a graph of all possible transitions once the motion graph is built a character can simply run through the graph to figure out the sequence of animation is required in order to achieve a specific desired effect this is where the AI comes in since while the motion graph fixes the design part of the problem you'd still need to run a system to execute the correct animations hence starting an absolution a new animation controller was integrated that rely on reinforcement learning if the system knows the current animation direction and speed it then figures out how to get towards a desired direction the desired speed and also whether or not it needs a transition to another animation in the process the original version used in hitman absolution is reliant on a simple variant of a standard greedy policy but it suggested that q-learning and basis function approximation have been explored and may have been adopted in later versions through absolution into hitman 2016 the core AI systems have been reinforced the croud system was optimized further and of course the bodyguard and VIP systems were integrated the same process has continued through into the 2018 sequel hitman - the details are still a bit sketchy at the time of this video but there are some notable changes that have been made as each system has been revised and iterated upon the most obvious change is further optimization to the croud system which according to IO Interactive can now handle over 2000 non-player characters this is highly evident and the second mission of hitman 2 at the racetrack in Miami they showcases this to fill effect secondly the sensory systems have also received an overhaul with greater fidelity and understanding of what's happening around them unlike in previous hetman games you can no shake off suspicious looks from NPCs by simply turning your face away from them rather than having to break the line of sight from your overall body plus the player can no better hide within crowds as well as use vegetation to their advantage sure that may sound like they're actually less intelligent but it's more reflective of hope players are actually playing the game but also providing a more realistic and fun experience but conversely the NPCs can now see you in meadows which isn't actually something that works by default in video games you have to program that in there yeah that may sound a bit ridiculous but hey this is game dev folks lastly some of the missions in hitman - notably the third mission in Colombia ups the ante by having three targets with each of them having fairly large patrol routes they can move along this has required even more flexibility where the game systems interrupt the paths these targets are taking if it becomes apparent that the player is attempting to complete a particular opportunity and force them back so you're not having to wait twenty minutes in order to make your play all in all hitman is one of the richest and most complex games I've came across here on EIN games as a number of bespoke highly tuned and optimized systems come into play to control a massive number of non player characters whilst also keeping the overall performance overheads as low as possible it sets the standard for the sheer size and scale of reactive real-time AI characters and hopefully the stole more to come from IO Interactive as agent 47 continues to do his business all across the world thanks for watching this episode of AI in games be sure to LIKE and subscribe for more videos looking at research and applications of artificial intelligence and video games I'd like to extend a huge thank you to Iowa Interactive themselves given Milton Fitz Travis the community manager at the studio reached out to me on Twitter last month to offer some assistance with this episode and passed on an early draft of this video to the AI team with Thomas Petersen a senior AI programmer and Kasper Fabray a principal programmer Iowans rights of providing me valuable feedback that shaped the final episode you've just watched and of course a special thanks to my patrons who voted for this episode to be made some of whom have been pretty excited to see hitman finally get a spot on the show if you want to have a voice in what games I explore next be sure to join the AI in games patreon via the links on screen now and in the description see you soon 