 Thanks thanks for the great intro Greg so this being an election year we've heard a lot about inconsistencies but I'm going to talk about inconsistent advertisements in neighboring a esas did how to detect inconsistent advertisements from neighboring a esas and our experience looking at these things from inside the AT&T network this is joint work with Morley mouth from University of Michigan and Jennifer rexford from AT&T okay so of course almost all of you've seen things like this this is just an excerpt from a settlement free peering agreement contract that I just happen to find on the web some people actually do put these things on the web so something that turns up in these policies the settlement for you peering arrangements wait frequently is that you know the neighboring a s is supposed to announce consistent customer routes at all inter connection points so what that means in simpler terms is that if you're appearing with some is like you you should expect them to advertise bgp routes at all peering points and the routes that they advertise so you should have equal a s path length and equal med values so why is this important well again you know why it's important if na s does this then it allows allows you to do hot potato routing you can show your traffic off on the closest peering points or actually wherever appearing point you choose if on the other hand neighboring s does not advertise these consistent routes as I've shown on the on the right side of this graph then it makes it a little tougher to do hot potato routing for example if a s1 sent a route on that pairing session on the right with a longer a s path length for example well then s2 is going to have a little harder time actually implementing hot potato routing actually restricts the flexibility that you have in your policy in setting exit points ok so we're we're concerned and trying to actually figure out why these types of inconsistencies happen when they do how can we actually detect them from inside our own a s and then once we've actually figured out how to do that in some practical fashion let's try to figure out how often this type of thing is happening is this something we should be worried about so first let's get to the question of why these inconsistent advertisements happen well the first one is obvious right your peer may be actually just trying to cheat you that's simple enough but the pier may not be sending inconsistent routes intentionally there are a number of reasons why you might expect to see these inconsistent advertisements several of which involve miss configuration and I'll go into detail on these and they're in the coming slides and others sort of have to do with some fundamental limitations with regard to the interaction between the BGP decision process and how people implement business contracts okay so let's first talk about the sort of simplest miss configuration that could that could cause this type of inconsistent advertisement you're probably way ahead of me already on this you know if a s 1 2 3 here that I've shown on the bottom you know has different export policies to its neighbor well of course the potential exists for these inconsistent advertisements to happen I've sort of given you just little snippets of cisco iOS here just to illustrate the point that you lookin at lookin at these configuration fragments to immediately detect the inconsistency isn't always obvious right you know both of these routers may have configurations that say hey to this appear use the route map called pier I mean you make so this would look there's a type of here that should be actually even I mess it up the you know the route map may say route map pier set prepend whatever and then and the rap map on the on the other router may have the same name for that route map but actually do different things so these types of things may you know if this is a simplest possible case right but even even these types of things may in some cases be hard to eyeball and actually immediately figure out that you've got a problem like this so I'm just going to take this moment to plug a tool that I talked about it the last channel that I call our CC which is the router config checker and you can run this over your configurations detect this type of inconsistent export policies quite easily so there's a URL you can go check it out please send me a mail if you're interested in using it and helping me with it okay so that's the sort of easiest mr. configuration that you can that you can imagine what other types of things can happen well here's here's here's another pretty pretty simple thing that could happen right so let's let's assume it in my a s I've got four routers and you know I'd like to set up full mesh ibgp but whoops I forgot a BGP session from that router on the lower left to the route around the upper right well so what can happen is you know if a comes in at this router on the lower left here then this router on the upper right is actually never going to learn that route so if you're if this a s is peering at these two routers with some other neighbor then at one of those peering points that pier is going to hear route a and at the other peering point that pierce not going to hear anything okay so you're probably thinking you know what else what else could probably happen well so let's let's assume now that some downstream a s sends a with some AAS path lengthen and another route be with a longer a s path length well note here that you do have kind of a signaling partition here because not only can the router on the upper left not here route a but the router on the the router on the upper right can't hear out a but the router on the upper left can't hear route be so that right around the upper left just going to advertise in a s path length rat with an AAS path length of to the right around the upper right is going to advertise a route with nance path length of three and and now you know even that even though that neighbor is going to hear routes at both of those peering points it's going to hear things that are inconsistent ie they have different a s path lengths so you're probably thinking like oh come on like this you know this sort of ibgp like failure to configure flemish like never happens right but these things can actually get like significantly more complicated when you start introducing things like route reflection right so here I've shown I basically dropped in the simplest possible ibgp signaling partition involving route reflection right I've got a top layer of three route reflectors but they're not fully meshed and I've got the same situation here again um so one thing I want to stress here is that again unless you specifically look for this type of thing this this this may be going on and you may not you may not even notice right it's not like reach ability is being affected here right that that peer whoever you're sending these routes to is actually is going to hear routes they're going to be able to reach the destination and unless you they actually take the time to look then hey this stuff may be going on and and we may not know about it and similarly like you may be doing this to your peers and not know about it if you haven't bothered to check for this type of thing so again RCC can look for these types of signaling partitions as well so what other types of things can happen well a lot of these inconsistencies can also be caused by things like BGP communities let's let's say the same AS and it's now fully meshed but it's it's got some customer that's advertising route to the destination at two places and maybe at one of those places the customer attaches a no export community well you know the routers in SAS may not may not all pick the same route the router on the upper left may pick route a the route around the upper right may pick route be also what happens when that runner on the upper right pics are up B is that that that route has a no export community and it doesn't send the route okay so this is sort of things that involve configuration let's talk about some sort of more fundamental limitations that can cause these inconsistencies to happen um so tink taking just supposing for a minute that you know we abide by that common restriction that if I na s learns around from up here it's not going to re-advertise that route to another peer well strange things can happen if you do if you prefer customer routes and pure routes to a single destination equally so in this example I've shown route a coming in from customer 1 and route be coming in from pier 1 well so what happens now is if that router on the upper right picks the pier route and the router on the upper left picks the customer route well pr2 up there is going to learn route a from the upper left but not route be now you may be thinking like this is incredibly contrived and you know perhaps have just made this up right well let's open the nano history books and Randy Bush isn't here unfortunately but I'll speak for him anyway we go back to nineteen ninety-seven we can see the situation that I just described to you on the last slide actually came up on a thread on the archives you can you can go read the thread yourself essentially what what Randy is saying here is that hey I've got uh you know I'm I've got some site that that I'm learning routes to you from both appear and a customer I have consistent export policy but because I'm not advertising my peer routes to other peers it could you know the situation I just described actually can happen okay so now that we know like that the types of things that can cause these inconsistencies to occur let's sort of dive deeper and try to figure out how we can actually detect these things how can I actually figure out as an AS sending me inconsistent advertisements okay so the first thing you might think of is really simple right well you know if I'm if I'm hearing routes a and B from some AAS well why don't I just you know look at the routes I'm hearing over ebgp and compare them and if they're different or if one's missing at some peering point then you know I go yell at them well unfortunately this type of thing isn't isn't tenable today you you kind of imagine how you might might do this right unfortunately we can't actually see the EBT routes all the ebgp routes that are coming over those sessions you'd need something like a vendor enhancement to say like a lot of the router to say give me all the all the routes I've learned by ebgp at a specific time right I can't just do show ibgp for example like I can't do table dumps because hey that table dump could take 10 minutes and if I'm dumping routes from both of these tables over a 10-minute period I don't know if that inconsistency actually happened or it was some like transient event that was going on while I was dumping the tables so I really need like some you know some sort of real-time feed to do this correctly um so yeah you know one one way to do this would be to require the vendor to actually you know tell me all the BGP routes all the ebgp routes I'm getting in real time of course another way you could do this assuming you trusted your peer and it wasn't actually you know doing that in this inconsistent advertisement intentionally as you could say hey could you send me an e BGP feed of your routes at separate router so I can actually monitor them that doesn't you know that approach doesn't really instill a lot of confidence in me the third is of course you could take packet monitors on on every one of these links and then see what's actually coming on the CB GP sessions um so it's unfortunately we don't have any of these things because this problem would would would really go away if you know if we could get just one of these things so what can we do instead well we can monitor the ibgp it's really easy right like we just set up a zebra router or some other type of monitor and we just start logging the ibgp messages we've got time stamps on them and we can figure out what routers what which of these border routers have picked which route is their best route at any specific point in time and then I could look for inconsistencies with the problem with looking at the ibgp is I don't get the full picture right I only get each routers best ebgp learned route at any one time so for example in this asf shown here if the router on the upper right picks throughout see then I only get to see route a and route see I never get to see route be so I you know just you know it's tough to tell whether routes a and B are equally good if I never see be alright so what can we do about this well let's try to infer something about be now even though we didn't see it because we saw route see maybe we could say something about route be ok so the trick here is to basically try to oh and the other problem with ibgp right is not only is that each of one of these routers picking its best route but there's policy going on there too so the routes I hear over these ibgp sessions may may be altered by the import policies on the ebgp speaking routers before I actually get to see them right so what I'd like to do to allow me to compare routes a and B is sort of say something about route be based on the fact that I saw her out see instead so what I want to do is take this route see that I've learned over ibgp and sort of figure out what it would have looked like over the ebgp session by inverting that import policy and then I'd like to be able to say that hey since this router is picking its best ebgp learned route and I learned about see well c must be at least as good as route be because otherwise it would have heard route be and then knowing that I could say if route c is worse than route a then either be also has to be worse than a longer a s path length etc or D wasn't advertised at all otherwise I would have heard it unfortunately I can't always do this certain things have to be true about the import policy to allow me to make these kind of statements now on the last slide I talked about inverting import policy so the first thing that has to be true about import policy is it has to be invertible the second thing is that the import policy on those those ebgp speaking routers can't take two routes that are consistent ie they have equal a s path length and they're both being in there all being advertised each the pier is advertising something at all those peering points and actually make some set of consistent routes look inconsistent so I'm going to talk about examples of import policy that violate each of these two things now so here's an example of a non-invertible import policy let's say that on these on both of these border routers I have some some import policy that says if the a s path length is 1 then prepend one twice if the a s path length is 1 1 then prepend won a single time well what am I going to here at this at this monitoring point if I hear one on this session on the left and 11 on the session on the right I'm gonna hear three ones for my ass path in both cases and I could flip flop these and I could also you know they might also be both a s path length of two or they might also both bas path length of one absolutely no it it's hell because my import policy has done something that doesn't allow me to reverse it based solely on what I see in the ibgp routes okay so the other thing that can that import policies could do potentially that would make our life difficult is to take two routes that are consistent in terms of a s path length and make them inconsistent so let's say that these border routers now have some import policy that says if the a s path contains the as5 then depress the route okay so what could happen here is that you know this router on the upper right if that router learns a route and around with the a s path for example 156 and a second route from a different is with a longer a s path length well then that router is actually going to choose the route with the longer a s path length so what we're going to see at this monitoring point is an ass a route with an ass path length of three one four six and a route with an ass path length of four to seven eight six but I can't say anything about what I would have heard or what I think I might have heard from ants one on this on this other border router because my import policies are making it impossible for me to see actually what's going on ok so these these are two cases that create some problems for us but in other in other cases the the technique I described to you or the logic I described to you for inferring what's actually being coming in over the ebgp sessions actually actually does work and we can answer some questions about you know how prevalent these these types of inconsistent advertisements are obviously the first thing we'd be interested in is trying to figure out how often these inconsistent route advertisements happen of course another thing to think about is how how how long are these inconsistent route advertisements lasting you know if they're relatively short-lived and we could probably write it off to you know convergence or something like that if on the other hand they're going on for days or weeks then it's probably time to make a phone call um and then the other thing to think about is you know how how badly are these these inconsistent advertisements messing us up are they causing us to send traffic you know from you know out appearing point in San Francisco instead of one LA or are they causing us to send traffic out of appearing point in San Francisco instead of one in New York just things to think about when we think about inconsistent advertisements so let's look at the first one how often it is inconsistent routes route advertisements happening well we looked at a week-long trace this is so i'm going to show you two types of data i said for i described the easy case when we had the ebgp feed and we did have this for one of AT&T SP and that's what I'm showing here when i show bgp announcements from one peer so we looked at a week a week long period of this trace and just looked at you know how often was it for the case when a prefect when a prefix was being advertised how often was it that you know it wasn't being advertised at all peering points or it was being advertised at all peering points but had different ask path lengths etc you can see that over the course of this week like inconsistent route advertisements are happening all the time so you might wonder like what's what's going on here so lets you know is that always the same prefix its that's being inconsistent or is it just short-lived stuff well it turns out almost all this stuff is short-lived you're going to write almost all of it off to convergence like ninety-nine percent of these inconsistencies last less than about 100 seconds well but there there are you know some fraction of these routes that are inconsistent for the entire period of our trace um as far as a as far as different as path lengths are concerned that seems to be even less prevalent again these these types of inconsistencies are quite short and in these types in consistencies we didn't witness in our trace so this was actually keep in mind this is not like a general result that I just showed you this was for one of 18 T Spears but for this case we could I mean it's pretty safe to say that most of these inconsistencies are caused by convergence but not all good it's important to look out for that tenth of one percent to actually see see what they're doing let's sort of drill down and sort of figure out what's going on with those inconsistencies which prefixes are being consistent for how long okay so what I've shown here the way to read this graph is on the on the x axis I have percentage of time so that's duration of time for the trace so and it's a log scale so 10 to the 0 ie one percent that would be like two hours roughly and 10 to the minus two is essentially a minute right so if we read up from for example 10 to the minus two we can see that you for this pier eighty-five percent of the BGP routes or eighty five percent of the prefixes had less than a minute during the entire week for which they were inconsistent in the sense that they weren't being advertised at all peering points that's what missing means in this case okay um you can read up for example from two hours right and it's basically like in ninety five percent of the prefixes were consistent for all but two hours of the week long trace that we looked at okay so you you might be thinking like is this just a well-behaved pier right what about other peers well I did take the ibgp technique that I described to you earlier in the talk and for those appears where we didn't have a BGP fees that we could look at we looked at some of the ibgp stuff and most of the peers look like the one I just showed you so for the graphs that we just looked at in detail with the missing and the different a spat length that's shown here as pr3 the Green Line so what I've shown here is I basically combined both cases of inconsistency different ask path lengths or not advertised at all peering points and just call that an inconsistency in this graph so again you can read this graph in the same way um so up here basically means that you know most like almost all the time like these prefixes are consistent and down here you've got a significant fraction of prefixes that are inconsistent for a large portion of time so what's going on with this this pr4 well that's probably someone we should make a phone call to write because it looks like you know about fifteen percent of the time I'm sorry fifteen percent of the prefixes are inconsistent for more than seventy percent of the trace that's like five days out of seven days fifteen percent of these prefixes are inconsistent that's probably not convergence okay so just in conclusion these settlement free peering arrangements are occasionally violated most of these violations we can explain away with convergence but there are a few significant cases where it's probably worth looking to see if you have this type of thing and you know if it's actually affecting the way your routing traffic some severe way so I did describe for the first half of the talk some way that you can actually detect these these violations without you no modifications to routers or having to have packet dumps on all your ebgp sessions you can do this with simple ibgp monitoring for a lot of cases of course if we had this monitoring protocol that dumped the ebgp routes this problem would be really easy so there are a lot of people from cisco here and i hope they heard that so another thing to take note of is it you know there are there are quite a few of these inconsistencies thousands in a week-long period and most of the time and then for the things that we that we observed the inconsistencies that we observed were mostly due to missing missing routes ie route not being advertised at appearing point where it should have been rather than different is path lengths most of the time piers seem to be well-behaved but there are some peers that we should watch out for as I mentioned there is one case we observed where more than fifteen percent of the prefixes were inconsistent for you know five days out of out of seven days so thanks for listening we've time for a five to seven minutes sure as we were talking about yesterday internal one of the things that we said we've seen is when you give Abby you're supposed to introduce yourself ah obviously thing about my one of the things that we've seen is when you give customers flexible flexibility by giving them communities they can cause inconsistent announcements so on your slide you showed no export for example if you have a pn i only community and you happen to appear with one is you know you know not at p ni and P&I elsewhere that'll cause inconsistency and if you take a look at a lot of policies you can actually look at some of the larger transit providers you could construct ways to do this inconsistency but it is those larger transit providers who are generally the ones most interested in getting consistency so in many of those cases if they just set up you know peering to zebra boxes to do internal monitoring of customers you know applying policy that causing consistency that might actually help that's a good idea a question sure so you know i understand something i understand some the limitations of incurring via ibgp it sounds like the real problem you're trying to solve is really understand if someone is going to built-in upon someone intentionally gaming you or redirecting traffic flows and it sounds like it might be actually easier to do something actually looking at the traffic itself that's chosen if you can't get a real live you know adjacency ribbon feed perhaps looking at the IPS from via net flow or other measurements and actually seeing the actual traffic chosen or selected on the outbound interface you know that is that is a good idea and it's another way to look at it and that's the problem is probably worth exploring I expect that I mean one one good reason to look at the routes is because it's pretty easy to separate the cases of convergence versus those that are that are that are clearly not convergent so I'd be interested to see if you could do the same thing from traffic is this just a transient like traffic fluctuation caused I you know a change in demand or is it due to the way I'm sampling my net flow or is this actually something I should be worried about and you probably could do it with with traffic to anyone else Thanks thank you 