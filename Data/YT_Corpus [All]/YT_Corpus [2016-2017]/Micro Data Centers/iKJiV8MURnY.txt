 hello everybody my name is Mihai stuff too I come from Romania I am a micro tech certified consultant and trainer I also do a lot of work for four different types of companies companies like ISP providers nuclear power plants weapons manufacturers and all sorts of other corporate clients we are we're going to talk about redundancy I've always had a passion for redundancy and the story behind this presentation starts a long long time ago I think this is pretty familiar with everybody so Janus is not the only one who was flying the Falcon yesterday and I also think that everybody knows what this is this is the frontal view of the x-wing fighter from Star Wars and this is a very interesting design because if you look at the x-wing fighter you will see that it has four engines and four wings and I was talking to one of my good friends is here today in in the room and he said he wanted to fly the x-wing fighter but he was quite afraid to do it what if one of the engines failed what if one of the wings failed so we started a big discussion on that and we decided that in order to provide communication between the engine systems we have to supply some mikrotik routers on them this is me and my fries is nobody you know discussing about about how we can set up redundancy inside the x-wing fighter and we decided that we would put four router boards on each wing of the of the X fighter so anyway getting back to serious business we will discuss about what Network redundancy is and it is redundant network redundancy redundant so is redundancy too much or should it be implemented at a very high level so first of all network is done Nancy generally refers to equipment redundancy and also to path redundancy so there are two types of redundancy we have equipment redundancy and path redundancy equipment redundancy is like this we have two routers and we have one active router and one backup router will which will take over in case of that if the main router fails so we have one router standing by what redundancy in its simplest form is something like this a highway with a lot of paths to which the traffic can pass so in case of mikrotik routers the simplest form of path redundancy is this one in which we have two routers and we have one backup path towards the second router of course we can do this when when we refer to is PS and then we have upstream path redundancy where we have our main equipment which is connected to multiple ISPs we have path redundancy for forest peace and of course speaking of path redundancy and equipment redundancy our mind will take us to two uptime guarantees which we generally find on hosting website so we will combine that and talk a bit about service level agreement so service level agreements are generally not based on pure facts they are based on mathematical calculations so on some websites you will see that the service provider is providing 99.9% uptime guarantee so how does he do that well he calculates it mathematically starting from from a thumb rule which is based on 1% monthly failure for each link or each device in his network so we will presume that our device will have a one percent failure rate or our link will have a one percent failure rate and we will calculate our possible uptime based on that first of all non redundant network so non redundant networks sorry I mean no equipment redundancy and now past redundancy how does it known redundant network look like in its simplest form it looks like this so we have one percent of possible downtime for device a one percent of possible town downtime for device B and one percent of possible downtime for the link this will lead to a total maximum combined downtime of three percent for our network so the best service level agreement that we can provide for our customers on this type of network is ninety seven percent guaranteed uptime so 100 percent minus three percent which basically sums up to 7.30 two hours per month of downtime which is reasonable time for such a network we also can build multiple upstream provider networks which mean we we don't have equipment redundancy but we have path redundancy and they look something like this and in this case we have our altar board which is our equipment and of course we have multiple upstream providers which in in this case based on one percent monthly downtime will lead to two networks which have combined total of two percent each and we also have one percent for our router so if we simplify that this is what we get we get the chance of having both blue and red networks down together of two percent times two percent if you will multiply two percent by two percent you will get 0.04 percent chance of having downtime on both networks you will then add the one percent which which you have on your device and you will get a maximum total of one point zero four percent possible downtime on this type of network which will lead to ninety eight point 96 percent service level agreement for your customers and then we have partial mesh networks which refer to equipment redundancy and also to multiple upstream paths redundancy which looks something like this in which we have one percent for each equipment in the network and we also have one percent for each link in our network so this already looks like our x-wing fighters so we have our four routers and how do we how do we calculate the possible downtime on this type of network where we in order for this network to fail it can fail with three points of simultaneous failure in six ways and these are the ways so it can fail like this with the chance of 0.01% of failing because we have one percent for this router and one person for that router so we have 0.01 chance of failure it can fail like this in which the router is above or our upstream providers it can fail like this with three points of failure and of course being the fact that we have three points of failure the chance for this to happen is much lower so you have one percent times one percent times one percent it can fail like this and like this so these are the main ways in which the network can fail if we sum that up we will get a total failure rate of 99.9 796 uptime guarantee on this network so we have four times the three points of failure and two times the two points of failure which can destroy the network so by doing this we have actually reached what the hosting providers generally put on their website which is 99.9% uptime guarantee so this is the minimum network you will require to provide the service level agreement of 99.9 percent and of course there are met works which are fully redundant but only partially and we will see why mesh networks we refer to equipment redundancy and also to multiple path redundancy without upstream path redundancy and they look like this now the main question in a network like this is do the blue links really help us well they do in what means core traffic or edge traffic but they will not actually provide better service level agreement because in for example in this one if we have a link between our routers in which are below in the image this will not help us at all because all the other links had have failed so on on such a network on such a network the links here will not help us so the the the service level agreement which you can provide on such a on such a network is 99.9 percent so how can we improve that well we can improve that if we use fully redundant networks and more specifically fully redundant mesh networks which refer to equipment redundancy and double path redundancy which look like this by doing double paths between our equipment we will actually create logical interfaces which have a much lower chance of failure because we have two links between each equipment each with a one percent failure rate and then we multiply it by the one percent failure rate of the link below so we get 0.01 percent failure rate per logical link so how do we do that on my critic that is the main question well first of all there are many ways to do it I will not go into all of them I will only present one way to do it this is perhaps not the best way it's one of the ways I like to do it so before you start with it there is a better way to do it this is just one of the ways and I will we use multiple protocols to prove the concept of fully redundant networks so what do we have well in our first stage we have have multiple interfaces which are totally independent we have either one connected to either one either two connected to e30 and so forth so what we will use is a bonding interface to connect the two links between each device we will use active backup which will allow us to have one active link and one backup link between each routers to do that you will have to go to interfaces bonding and simply add a bonding interface and then add the the slave the slaves for for the bonding interface select the mode and select a primary interface you have to be careful because this primary only works for active backup mode so if you will use another type of bonding the primary will probably not work and you will repeat this for every link in your in your network so our resulting network is as seen from the point of the routers a logical network with a 0.01 percent failure rate for each link which has three bonding interfaces per router so we will have bonding one bonding two and bonding three per router of course on router 4 and the router 3 will have the same link bonding one as we have on router one and router 3 so we will also set up loopback addresses 4 which will be used in OSPF further on a loopback address is a device which is a bridge that has no interfaces connected to it so if you did MTC Ari you should be very familiar with the concept so you will have to add one loopback device each router for every router in the network and this is done by adding a bridge which you name it lebesgue zero or whatever you like and after that the device is active as a loopback device you will have to add loopback IPS on the loopback device which will be IPS with a slash thirty-two netmask they're generally used for OSPF router ID so you will have to go to IP addresses and add the IPS on on the loopback device so what we now have is a network which has loopback IPs of 192 168 1 1.2.3.4 for the whole network and we will have to interconnect the routers on generally the interconnection is a slash 30 but I have used that slash 29 so that we can keep the numbering between the routers so we have 10 1 network name and then router number if we look at the network schematic we will notice that even though there are three bonding links we actually have 6 networks available so on bonding one between router 1 and router 3 we have Network 1 but on bonding one between router 2 and router for we have Network 3 so due to the network schematic even even though on each router we have only three bonding interfaces we will have 6 different networks so we we just add the the interconnect networks to each of the of the routers and the numbering schematic is that we will use the link number in in this one so for example for link one between router 1 and router 3 we will 10:1 link number and then router number so I will know that if I have ten one five three slash twenty-nine I will actually have the router three connected on network five so after adding the interconnect networks I hope this feels a little bit like training after adding the interconnect networks you will have to do OSPF setup OSPF is a dynamic protocol which exchanges route between interconnected interior routers on your network to use OSPF you have to go to routing OSPF and simply add add the network's to SPF but first you have to define the default instance and you will set the router ID to the loopback IP you have set on that router as as the router ID used in OSPF and then you will notice that in in OSPF network you will have to add all the interconnected networks - to the specific router and also the loopback IP which will be redistributed between the routers in the network so what do we have now on all four routers we will notice that we have all the networks that the routers are connected to and also in the address list we have simply added the IP so the setup is very simple you just set the loopback IP you just set the interconnect networks and then you redistribute that via OSPF and that's it to get the networks running and we'll zoom in on router 4 and the router 4 we will see that in in our routing table we already have all the networks in in our fully redundant network available in the routing table and this is this is due to the fact that OSPF has redistributed the the networks between the routers so all the networks are already available in all our routers so this is just simple OSPF setup so basically you can do this to create a network like this this is the basic network which from my point of view every iSpeech you do should use or should already be be using where you have to border routers or two edge routers connected to your eyes piece and then you have your core access and then you have you have your access routers which can be customers or can be part of your own network so we have two eyes ps4 routers in our network and our redundant customers so always be a specifics OSPF is a very good interior routing protocol but it has its limitations and I think everybody knows that in larger networks convergence time is a problem and this is specific to SPF it's very easy to use but if the link goes down then then you have a serious problem when the link goes up because you have to wait for the network to converge so how can we fix that we can fix that with Internet working traffic engineering tunnels which can be very easily deployed on mikrotik mikrotik makes it very easy for us to use traffic engineering which is actually part of internet working so if you want better and faster control over your network you can use traffic engineering for that and in order to use traffic engineering you don't have to deploy mpls throughout the whole network you can just add it to SPF and reduce with that in you know SPF so we'll we'll take this very complicated network and simplify it for the purposes of the demo we're gonna simplify it into something like this where we have one provider and we have one customer router and we have kept the the fully redundant network for the demo purposes so the rest remains the same if you want to follow this network schematic throughout the presentation you can go to this link and it's available there you can open up in your laptop and perhaps follow it easier so first things first the first thing you have to do in this network in this one you have to add the default route or router one this is very easy to do if you have a second provider which is connected to your router - you also have to add the default route - router to the third thing you have to do is the customer set up and and also you have to do the configuration on router 3 so to do that you will simply add the connected network I have used one 7 to 1600 / 24 for the customer network so we have 192 168 1 1 1 2 1 3 1 4 for loopback IPS we have interconnection IPS from range starting with 10 and we have customer network starting with 170 in order to create the traffic engineering you have to distribute Oh pack lsas inside the MPLS cloud to do that mikrotik makes it very very easy for us even if we don't have internet working experience you will simply go to the instances you will choose the default instance and then you will choose MPLS traffic engineering area you have to keep in mind that the traffic engineering area is unique throughout the MPLS throughout OSPF and if you choose the backbone you will not be able to use another area for doing traffic engineering so when designing your network you have to be really careful careful what area you are choosing and of course you will set the router ID for the MPLS key area with your loopback address and you will have to do this on all four routers and after you've set up the the OSPF traffic engineering area you will have to add the interfaces to the traffic to the traffic engineering and pls so you'll have to go to MPLS traffic engineering and simply add the bonding interfaces which you created in the initial setup to the traffic to the traffic engineering in my example I have used one gigabit bandwidth allocation for for the bonding interface which is corresponding to two interfaces having one gigabit links so you do this on all four routers and you also have to keep in mind that traffic engineering tunnels are unidirectional tunnels so you will not get downloaded and uploaded on the same tunnel you have to create a separate tunnel for a download and the separate tunnel for upload this is very important because in the setup you have to create two channels for each bonding link you have in your setup so which are the possible parts in our network so the possible paths in our network are let's say we're looking from router 1 towards router 3 so we have one possible path which is direct path then we have a second possible path which is through router 2 in traffic engineering if you want better control over your traffic you will have to use the interconnection IPs when specifying the path and we will see how to do that we also have a third path which is through the router for a fixed path through a router to the router for the router 3 and we also have path 5 which is through router for router 2 and then router 3 so these are all the possible paths which the traffic can take to reach router 3 when starting from router 1 so this is download traffic for our customer so to do that we will create the path to create a path you will go to traffic engineering channel path and add your path I have named them router 1 to router 3 router 1 to router to to router 3 and so forth so you manually add all possible paths in your setup and then you you have to get to check ucsf PF unchecked because this is dynamic and we will use static a static path and then you have to specify the hops to towards towards the router you have to also specify the next hop and the local preferred source which is being used for exiting that router from from from the path so in in this case for example if you want to specify the path from router one router for out or two and then router three you will use the first next hop which will be ten one six four then you will specify in the path then one three four then specifying the path ten one three to ten one five two and then ten one five three and this is done in tunnel path in traffic engineering so looking back from router three we will also have the same five paths but in reverse order so we will have from router to router three to router one direct path this does not have to be specified in the hops you will have a path through router 2 between router 3 and router 1 you will have another pot like this and you'll also have another path like this which is part 4 and of course we will have the last cross paths through router to router 4 and then router 1 so you basically set up the reverse tunnel for upload traffic in the same way it will go to traffic engineering Tunnel path and set up all the possible paths for for that router in in this example I have used the R 3 R 2 R 1 part which actually has strict hot the hops can be strict or loose in case of loose hops you will allow intermediate hopes to be used without being specified in the path but in our case we want final control on our traffic so we use strict hops so the last thing we have to do is set up the actual traffic engineering tunnels on all the routers so in our case the first traffic engineering tunnel that we will use will be from router want router 3 to have the traffic engineering tunnel you add it just like every other tunnel you will add a traffic engineering tunnel which will name it you will specify the loopback IPS which will be the hops this is actually why you are using loopback eyepiece because if you are using loopback IPS for the traffic engineering tunnel then your link failures will not affect the link state of your tunnel because you will have multiple paths throughout your network so you will simply specify the loopback IP source and loopback opinion destination you can make a bandwidth reservation through that path and also you can specify your primary which is your preferred path and then you have secondary paths you have to keep in mind that secondary paths will be used in your preferred selection so you can select if this part fails the next part I want to use is this one and in case that link fails it will be selected automatically just the way that you want it to be selected also you have you have a reoptimize interval which I have used in with five seconds in case that the bandwidth which is available on the traffic engineering tunnel is no longer available through that link then the traffic will follow a path that will reserve bandwidth on that tunnel and you do the same thing for router three which is upstream tunnel so you have one downstream tunnel from router one and one upstream tunnel from router three through router one so what are the traffic engineering effects on router three if you will look to two interfaces you will see that the available bandwidth has been reserved this is specific to traffic engineering tunnels in there are the only tunnels that can actually guarantee band white between equipment so in in case you reserved 250 Meg's of traffic on a Gigabit link you will only have seven hundred and fifty megabytes megabits per second available on that link so in order to route traffic you will specify on router one the destination network in your routing table and you will specify the Gateway as the downstream traffic engineering tunnel because it's a tunnel mikrotik will let us use it in the routing table from mt CNA you probably know you can't use interfaces in the routing table well in internetworking you can you can simply specify the tunnel and the traffic will move downstream through that tunnel and our router 3 to move traffic towards the default gateway you will simply set up a static route towards the default destination through the traffic engineering tunnel and then you will have you will have obscene traffic through the tunnel and downstream traffic through the tunnel so final checks and tests you have to of course check if DNS is working on all the routers check that MPLS te o pack Alice's are being redistributed through throughout your OSPF you can check that in the L essays you know SPF you have to check if NAT is working if you're using that and then test it from the customer side in order to check if the traffic engineering tunnels are working you will have to check the interface counters on each traffic engineering tunnel because what is very important is that you will not see receive traffic over those tunnels you will only see obscene traffic so transmitted traffic which actually looks something like this so in our case I have traceroute towards micro tech comm and it's working and also if you check the interfaces you should see the TX packets which are being used by fresh world so this is basically the way in which you can implement a fully redundant network which uses bonding links and also control traffic very well throughout your network with preference over your paths throughout the network so thank you very much if you have any questions do we have questions yes how do you handle the single point of failure where you take the connection from the carrier say cogent or hae and they give you a slash 29s you've got addresses for two routers but only one physical interface to the the upstream provider you you have to you have to use traffic balancing or you have to have multiple exit gateways I have used the simple example to prove the concept but in real-life networks you have to have possibly done as if they only give you one link then that's all you have you can't you can't fix it thank you thank you any more questions No uh yeah sure one question about the tunnel generation how about if you used OSPF with BFD so we have fast convergence and CSP is and CSP F based tunnels so you have quick recalculation of OSPF and quick and by that way a quick recalculation of MPLS tunnels yes you can do that but actually BF D which is the directional forwarding detection is not being used to reduce convergence time it has been developed when you have when you don't have control over your over your transit area for your traffic when you have for example multi-hop BGP and you want to know if your link had had failed and you can't detect that so that's when you use PFD you are actually correct in stating that if you use BF d then you will have a better convergence time because BF d will imply that and you can truly use dynamic tunnels but if you use dynamic tunnels for example over if you take this network generic and you put it over a national area you might have links which are not symmetrical you might have one gigabit link and you might have one link which is 100 max so you you might want to use specific parts you can do that but if you use dynamic it then you won't get your preferred path you will get the routers preferred path okay thanks thank you more questions thank you my first and what is the convert this time between tunnel to return the tunnel well it actually works at about one second two second maximum it's a very difficult lab I hadn't planned to make a demonstration but I don't have enough 