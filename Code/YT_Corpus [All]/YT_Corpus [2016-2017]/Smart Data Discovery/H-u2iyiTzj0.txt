 hi welcome back to discovering patterns in the microbiome in this slide we'll be talking about visualizing diversity and specifically discussing the differences between principle components analysis which is PCA principal coordinates analysis which is Pico a and then non-metric multi-dimensional scaling so the first thing I want to do is is just give you a quick overview of the whole process of going from the input table through beta diversity analysis to the ordination technique now so I want to give a quick overview of the whole process where we start with a data table let's call it X and this is where you have samples here so like sample 1 sample 2 sample 3 and then the columns could be ot use they could be general that could be any feature so let's just call them ot use or let's say they're generous so g1 g2 g3 debt and what what we typically do so we can do lots of statistical tests on the general we can calculate alpha diversity but when when we wanted to measure overall changes in the microbiome structure we run this through beta diversity oops and and this is where we're basically calculating the difference between the overall structure in the community between every pair of samples so we end up here with a new matrix that is Square and symmetric so it's now sample 1 sample 2 sample 3 and the rows and sample 1 sample 2 sample 3 and the columns then of course along the diagonal what do you have zeros so the distance from sample 1 to sample 1 is 0 sample 2 is sample 2 and so on and then the rest of these are whatever distance measure we choose many of them range between zero and one so let's say you know s sub sample1 and sample2 might be 0.5 sample one two sample three might be 0.75 sample two two sample three might be point six and then it's going to be it's going to be symmetric as I said so it'll look like that whoops now once we have this big table there are certain statistical tests we can run on the beta diversity directly but we ought what we often want to do is to visualize the beta diversity on a piece of paper so that we can send something off for publication or so that we can explore the overall variation in the data so so that that's the process that's called ordination so we'll take that distance mint matrix and do ordination and then what do we get well it's going to be a new matrix that is it still has samples in the rows but the columns are now the they're now principal axes of variation so this would be say pc-1 pc2 pc 3 and we often don't look beyond PC 3 although there can be very interesting things in PC 4 5 6 7 8 and so on so the the topic that we're discussing now is how to do ordination on the beta diversity side we already mentioned uni frac is great when you want phylogenetic diversity when you're dealing with ot use if you have general or other features then we often use break Curtis and then finally if you have gradients we often use the Chi square the Chi square distance metric but for ordination there are several approaches the most common one in the microbiome is principal coordinates analysis this comes from the fields of ecology and it's different from principal components analysis and so that principal coordinates is p coa and then principal components analysis as pca then finally some people use non-metric multi-dimensional scaling NM TS so we're going to we're going to compare these ordination techniques once you've run the ordination technique then you can plot the samples on pc1 & pc2 and start to see whether for example there's some clustering you know based on based on your experimental groups so so what I'd like to do now is discuss differences between Pico a PCA and MDS using some code demos here we are on the code browser we're going to go down to ordination which we're doing on the guerrero negra dataset again at the top of the top of the page here you see we're loading the biome package and the vegan package which we've already done before and then here are a bunch of commands that we've already used for for loading in the OTU table and calculating some distance metrics I want to point out one difference here which is that we're we're where is it we're changing the OTU table to be relative abundances so when it's read in raw it's just the actual observations of ot use so you saw this Oh to you once and this sample 40 times on that sample and so on and that's going to cause problems if samples come from dramatically different sequencing depths so this command right here with sweep is basically saying take the o2 table the one refers to rows instead of columns sweep across each row dividing by the sum of that row and that's going to make the each row sum to one now first thing we're talking about is PCA outside the field of ecology this is common the principal components analysis is a common technique for doing dimensionality reduction it turns out that it's basically equivalent to doing principal coordinates analysis which we've been using so far with Euclidean distances and as we saw in a previous video Euclidean distances are generally not as good for microbiome data in fact sometimes they're they're outright they're downright horrible so so PCA tends not to be a good thing to do with with the microbiome PCA takes the raw data table and goes straight to the ordination there's no beta diversity in between but it's equivalent to having Euclidean beta diversity and then principle coordinates now I'm going to calculate it here just for demonstration purposes so the way we do this is PCA doesn't work if you have more features than you have samples so we're going to pick out just the ten dominant ot use which I've done here so basically sort the OT use by by their column means what's their average abundance I want it decreasing and this order function is going to tell me the order of the columns in decreasing order then we take just the first ten of them and now here's where we do principal components analysis in R so we take the otu table pull out just those 10 dominant ot use and run prin comp that's the function for PCA and the the dollar signs scores is going to extract the scores matrix from the result so we store that in this PCA dot 0t use variable then for Harrison we're going to calculate Euclidean distance on the same subset of the OTU table and then do principal coordinates analysis or CMD scale and R then I will plot the the principal the first axis of principal coordinates in the in the principle coordinate analysis of Euclidean distances that's the x-axis and then the y-axis we're going to show the first axis of principal components scores using principal components analysis and here's what you get so they're they're identical up to a scaling factor so this validates the the fact that they're basically that it's basically doing the same thing the next technique we're going to look at is non-metric multi-dimensional scaling this is mmds we can do this using the vegan package and and we're gonna run this on the OTU table and then we have to pull out the points matrix that's the actual scores on pc1 & pc2 for n MDS so here's what happens when you run it and and then we're going to use the same approach we used in the beta diversity video for for making the plot so we're making this little set of colors that range from red to blue and then we're going to color by which layer the sample came from in the microbial mat then we're just plotting here the first column of the match non-metric multi-dimensional scaling on the x-axis the second column on the y-axis and here's what we get this is this is basically the same level of quality for recovering the gradient of depth along the first axis you get a little bit less of the horseshoe effect and you know you saw that very nice arch in in the other analyses whether that's a good thing I'm not sure you know if it's recovering if it's as likely to recover gradients I know it's not as likely to recover gradients as the Chi square distance in general so we can do Pico a on the brake Kurtis distances we've done this before just for comparison here's what we get there and we see we see basically the same recovery along the x-axis but with more of this arch effect the which we're going to go into later in general people use Pico a much more often in microbiome analysis than n MDS so I recommend using Pico a no one's going to complain about it and the way n MDS is calculated is a little bit hacky it basically like keeps doing this iterative thing and then it does it a bunch of times until it gets the same answer twice at least that's how it's implemented in the vegan package so where where as principal coordinates analysis has a much more reliable statistical foundation one interesting thing you can do once you have once you have an ordination plot is to ask how the different features so those are the species genera ot use etc vary along each axis and there are various ways to do this so one reason why people often use PCA this is principal components analysis is because it automatically gives you what are called the loadings of the features along the first axis second axis third axis and so on so you can easily plot where those features are on each axis this is so this kind of plot is called a by plot where you've got one set of points for your samples and another set of points for your features you can also do this with principal coordinates analysis if it doesn't have quite the same statistical rigor as doing loadings in PCA but then again you get the benefit that you're using whatever distance metric you want so I'll show you how this is done typically in principal coordinates analysis or for any any organ other than PCA or correspondence analysis which we'll talk about later and what you do is you basically you basically treat each feature as a weighted average of all of the positions of the samples that that feature is in so to do that we're going to renormalize the otu table by the columns so that the columns sum to 1 which means if an o2 is highly abundant in say sample one and just a little bit abundant in samples two three and four then most of the position of that feature in along each axis is going to be determined by sample one by the position of sample one then we can just use a matrix multiplication so we multiply the transpose of that the transpose of that feature table by the principle coordinate scores and that sums up and gets a weighted average along each dimension the then we can plot the principle coordinate scores again that's the same command we had earlier and we'll use this points command to add the weighted average positions of the OT use in each axis so here we have weighted average the this is the matrix that came out of that matrix multiplication so weighted average is taking just the top ten ot use and remember this this ot uix variable we set earlier to have just the top ten Oh to use so we're going to plot the the first axis scores by weighted averages the second axis scores I'm going to make the points a little bit smaller than the sample scores and use hollow black circles that's PCH one then I'm also plotting at the same positions the names of those ot use using the text command and here's what we get so these are these are the samples in color and then the OT use that are most dominant as weighted averages of those samples and then the text that's there is just the OU tu identifier so that these are close reference ot use so those are the green jeans identifier for the OT use you can also do principal coordinate a coordinates analysis and chime including 3d coordinates which is really useful some other nice aspects and then and then finally you can also do the by plots in China so now we're going to switch over to the command line this is no longer in our this is on the UNIX or Mac command line and the way you have to set this up is to run first beta diversity and we've done this before this by default this calculates the the weighted and unweighted Yuna frac beta diversity matrices but you could also run if you do beta diversity beta diversity dash S will show you all of the matrix metrics that are available so you could run chi-square you can run Euclidean you can run break Curtis and so on so we run beta diversity that gives us a distance matrix we do ordination by running principal coordinates so that's this command and there we just input the the here we're using unweighted Union frac and then we output the principal coordinates analysis file which I've called Pico a underscore unweighted blah blah blah and then the way that you make the 3d plus is with make Emperor so Emperor is the name of the package that's used to visualize the 3d plots so you use the chyme command make Emperor and this is one of the most popular commands in chime you input the principal coordinates analysis table you pass it your metadata file the mapping file so that it can color the points by different metadata features you give it an output folder which I called 3d and then I here I've set number of segments so this basically controls the smoothness of the spheres of the points and you can go up to 14 if you have a lot of points like a really large data set then I recommend not changing this value but otherwise it's nice to make them a little bit smoother so you get this output table when we run when we run this command this is going to give us an output folder and then we can open there's an index.html file that we can open in our favorite web browser so here we have this in I have this open in Safari which is not my favorite web browser but it opens more easily and then you can actually rotate the points around in 3d and here we see the the gradient so let's color these click on the colors tab color by the ends depth of a sample and here you see that that they're ordered by depth and they're kind of winding around in 3d space like this we can also turn on sample labels if you want to find out which sample is which and you can also change which axis you're looking at so if I wanted to see so PC one is the dominant gradient if I want to compare that to PC 4 and 5 and see if anything interesting is going on you can do that too and in in large data sets you sometimes will see very interesting things parallel axes is another way another very nice way to see if there's any interesting signal in the later axes of variation for example we might look at a data set that had two treatment say three treatment groups you might see that PC one two and three are explaining the difference between say one treatment group and the other two plus some other variables like you know batch effects in your sequencing run or whatever but if you look at the parallel the parallel axis plots you'll you might see that somewhere out in PC four or five or six all of a sudden other two experimental groups get separated along that axis so that would tell you you might want to go in and visualize those axes so this is just a nice way of of exploring your data and then you can take screen captures and use these as figures in a paper as I mentioned you can also make by plots in chyme you need to have a tab delimited tax on summary file so when you run summarize taxa this chime command you get out a biome version and a txt version then here I'm asking it just to produce level six taxonomy that's genus level we run make Emperor this is the exact same command but here we have - t OTU table l6 we open the resulting HTML file and what we get is a similar plot that shows not just the samples but also not just the samples but also the top ten or so taxa and where they are and these are genus level taxa if we go to label the labels tab up here we can turn on the buy plot label visibility and get labels put on those it's a little it's a little unwieldy because these labels are really long so it's hard to tell what's what but if you wanted you could go in you could open the you could open the genus table in Excel or spreadsheet app and easily just edit the names of the genera to be shorter for a nicer display and that by plot so so that's that's basically a summary of what you can do in chyme with various distance metrics and principal coordinates analysis including generating by plots 