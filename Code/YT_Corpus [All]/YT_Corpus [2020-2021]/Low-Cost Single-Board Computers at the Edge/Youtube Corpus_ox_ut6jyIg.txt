 welcome to episode 175 of the Microsoft cloud IT pros podcast recorded live on April 24 2020 this is a show about Microsoft 365 and Azure from the perspective of IT pros and end-users where we discuss the topic or recent news and how it relates to you in this episode Ben and Scott discuss Asscher file shares for client devices domain controllers Azure 18 networking and other cloud services and how they all fit together the Thunder is never done all the tornados rolling through it was nasty last night you know what I did not hear a thing I may or may not have been up until like 2:30 the night before working on stuff and then I crawled in bed at like 12:30 last night I was so tired I passed out and I woke up when one of my kids came in her bedroom at some time 4 a.m. and my wife was like did the Thunder wake them up it's like it was a thundering I look I never know the thing man Korona times have not been kind to my sleep schedule it's turned into like ah you know let's watch a movie and then the movies over it's like yeah yeah maybe it was like just just one TV show or let me read this book for a little while or whatever it happens to be so I think last night I was up until last I was late when it was 3 a.m. hence my coffee brewing slowly this morning so I heard that whole single through in the whole thing I was in my kitchen was awesome coming through it was a good one I like a good storm so I woke up and I was actually bummed it didn't wake me up cuz I'm the same way I love a good thunderstorm especially at night for whatever reason those neigh thunderstorms and the Lightning lights up the whole house and the Thunder just rolls it's I don't know it's cathartic for some strange reason well as long as there's not a tornado blowing my house down yeah well there is that whole thing but it was definitely a good thunder and lightning storm and you know it was tornadoes and stuff further to the north but not so much for us so it was just a good rain event yes I will say night growing up in Jacksonville I have been impressed with the geographic surrounding of Jacksonville and how it seems to deter most storms from hitting us like we never really seemed to get tornadoes are really bad storms from the West because of the river and because we're sitting just down low enough I think the Gulf of Mexico messes up a lot of them and then the way Jacksonville is kind of set in on the coast if you're going up the Florida coast and up and up Georgia and South Carolina it seems to deter any hurricanes from really having a direct hit on Jacksonville yes it is the furthest point west on the East Coast like when you think about that dip in so it's not just Florida to Georgia and all that like pull out a map and look all the way up it is the furthest point west from Maine all the way down to us what about the keys don't the keys loop back into the West they do but there sit but they're sitting actually like they're just sitting in the middle of the ocean they are right but if they're all the way down at that eastern tip of Florida is you know think about like going down to Miami and you're pretty much a straight line down to the keys from there you know so they are still further east than we are but as a chain of islands they stretch pretty far over but at that point they're underwater anyway know as a landmass with two big bodies of water like you talked about between the ocean and the river being a pretty substantial River but at least nice and wide you know it's good enough to pick up a lot of the weather that comes through here I remember that growing up in Michigan - I mean like Michigan is significantly bigger than the river but Michigan was spared at least a lot of the bad thunderstorms and tornadoes and all of that because of Lake Michigan they would hit Wisconsin the lake would break it all up before I hit Michigan I wouldn't spend a week in Wisconsin it was like tornadoes every day but don't go to Wisconsin don't kiddo sorry to anybody that's from Wisconsin that's listening I much prefer Michigan to skansen you're gonna start a fight or something probably I have some good stories about Wisconsin and Michigan but we don't need to talk about those today as IT professionals and the cloud era sometimes it feels like we don't speak the same language as the rest of the organization so when stakeholders from finance or other departments start asking about a specific project or team's azure costs they don't always realize how much work is involved in obtaining that information sifting through cluttered CSVs and a complex mass of metadata in order to manually create custom views and reports it's a real headache on top of helping you understand and reduce your organization's overall as your spend share gain overcast lets you group resources into meaningful cost tubs and map them to real-world business scenarios this way you can track costs in the way that makes most sense with your corporate structure whether it's by product business unit team or otherwise it's a flexible intuitive and business friendly way of tracking Azure infrastructure costs and it's only available in share gate overcast find out more on share gate comm slash IT Pro should we talk about what I was staying up late playing with today yeah it sounds like you were staying up late doing things that I was not well I was watching you know crappy movies and contributing to Netflix viewing hours you were doing real work supposedly well so supposedly because it all started with a client question which led to me playing with us with my own domain and Azure tenants because I don't want to break anything so to set this up as your files with so esra files has been able to do SMB for a while you can use the like storage account name and the private key to actually map a network drive to as your files all of this they have recently and I think it's still certain aspects of this are still in preview yes the ability to do as your files over SMB leveraging either Active Directory or Active Directory domain services to authenticate users to the file shares rather than using a storage name and a key so that all of those MTFs type permissions can be used are supported through a mapped azor file share but there are a ton of restrictions and requirements and prerequisites around doing that which could lead to the question that we were actually debating before we started recording of should you actually do this and if you do this what all do you need to think about because this has led me down a massive rabbit hole of V nets and DNS and AD and a DDS and all of that yes and you're leveraging preview services which is even well preview functionality I guess which makes it even more interesting so when you initially came and you had asked me the question of okay I'm trying to stand up a file share and I'm doing the domain Athan occation thing and it's really a pain and in the back of my head I'm thinking isn't that relatively new and probably in in preview and you know my first question back would be well why do the preview functionality right especially if it's for a customer like typically we don't want to take customers into preview stuff even if it's public preview because if we just consider Azure life cycle there's no guarantee that a preview service ever actually goes g8 so obviously Azure files is g8 and all that kind of stuff and it's sitting there ready to go but Microsoft could look at this feature where they're doing SMB file shares with ad with Azure ad rather and with on-prem ad and they say okay I don't want to do on Prem ad anymore I'm only gonna do ad because that's an easier scenario to support well but it's not just a ad it's a a DDS it doesn't support a ad yeah yet remember we got to clarify these I get my storage confused because there actually are parts of storage like blobs and containers which do support Azure Active Directory oh for role-based access controls and things so you can totally do ad authentication that anybody who thinks a sure storage isn't a confusing service being that it's a storage account but it's not just a storage it's blobs it's files its tables its cues its disks its it right it's got like sub service a you know it's static websites it's like 10 other different things it's amazing as your as your files are gonna be like the team's of office 365 where everything's just gonna get sucked into the storage vortex well if you think about it the storage is kind of important right in the grand scheme of things and the overall fabric because what is a sure it's a bunch of hosts who are running hypervisors and it's a bunch of file servers that are pulling configuration off of storage controllers and things like that right right at the end of the day storage is what makes sources it makes the world go round which is digressing so this whole storage authentication thing I'm not going to say it's just as you're a DDS should I go through the prerequisites and what I found and then we can keep talking through this scenario sure just to lay out the scenario what you're trying to do is you're trying to stand up a file share in Asscher yep that is available to clients not to other servers that exist out there but going to a server but to individual clients and you require per user authentication from each of those clients to the file share right right so scenario being client does not want to use SharePoint or onedrive because they don't want to deal with the whole sync thing and file send demand thing and having to access the browser and maybe not being able to sync all their files based on hard drive sizes and all that they like traditional file shares unpromising the cloud and they want to be able to work from anywhere so said client wants to be able to go to Starbucks or go home or be in the office and be able to map to their network drive the same way they would if they're on premises and this is a they're not a huge client so they actually don't have a current VPN to get to their UNPROFOR off premises they can't VPN into their office internet connection is okay but it's not like a large enterprise network that has cisco has VPN has all of that stood up so they were like well what if we just move it everything to the cloud and we can map this network drive from anywhere using our traditional ad usernames for securing all of this across all of our users I always love when customers come up with their technical solution hey they have a business problem they're trying to solve the technology that solves that problem really shouldn't matter as long as it aligns to the business outcome so what is it what is the process the workflow or the outcome that we're trying to solve and then you can backfill technology around that they're going backwards they're coming to you with the technology and saying hey make this work and then yes because I spent some time with them we looked at SharePoint for maybe six or seven months and ultimately the decision was we don't want to use SharePoint we want to use Azure files so I was tasked with figuring how can this be possible does this work especially given some of these new features combined with the preview so for this all to work you do still require Azure ad but it also requires either an unpromising server or Azure Active Directory DS or domain services so you have to have one of those two synced with your Azure ad and have your users synced in both places and then you can go configure this file share for either Active Directory authentication or act as your Active Directory des authentication but it's still also using Azure ad in the background correct in the problem we started running into well the first problem we ran into is SMB 3.0 which as your file uses goes over port 445 tests almost every isp blocks port 445 they do true story so first problem was okay we need VPN for it which we can talk about that more later and then we got VPN setup we started testing this and there's a bunch of prerequisites your machines either have to be hybrid azure ad joined or they have to be a DJ but once you get all this set up and configured when you go to authenticate to map your network drive your computer even though it's using Azure ad synced with ad domain services or ad it like reaches out but then it's like oh I also still have to use domain services or as your ad so it requires access to both Azure ad using your UPN and azure ad but then it like takes a side route and goes and has to ping your domain server or your Azure Active Directory domain services server to actually do the verification to your freedom Ave network drive which means that if you're at home or if you're somewhere not in your local network or anywhere for that matter you have to be able to properly authenticate against either a domain controller or azure ad domain services wherever you are which means it has to either go over that same VPN that you can use to bypass the port 445 rule or it just has to be a publicly available domain controller which we all know is about it yeah almost kind of like gives you the sense that as you talk through it and the requirements that while it works with clients like Mac and Windows I think it works with Windows 10 and generic SMB mounts and totally doable with the Mac and things like that it's almost like I'm not meant to be used that way yeah yeah back to that shoehorning functionality yes exactly but what fun would life be if I didn't try to shoehorn in some functionality that wasn't meant to be using preview features oh boy I like to live life on the edge es it's a world you live in so you have a number of problems or technical blockers that you need to solve along the way there you need to configure identity in the cloud so some type of probably replication and resiliency on the domain side of things because the first question there is do you do a server running Active Directory in the cloud and replicate or do you use Azure a DTS you need something in the cloud yes so there's that piece and that's certainly its own can of worms and and decision matrix right there and then you also need a VPN as you said so where does that VPN endpoint live and how are your clients going to connect to that VPN I'd imagine maybe one of the first inclinations is you might think in your back your head well I have clients let me connect the clients through point to site VPNs and just you know come straight up to the gateway there's some limitations to point to site VPNs depending on the size of your customer there are limits to the number of connections that you can have going in at any given time which could be a limiting factor for you there and then once you're into the VPN there's all the routing and network security and other things that need to come into play for that client to not only talk to the DC itself but to be able to get back to shore files and do all that fun stuff yes I think you covered the biggest ones that I've encountered so far yeah those would be doesn't be most of them so so let's break some of them cuz I think it's an interesting conversation just based on some of the paths you went down and some of the things to potentially broke and we probably talked through why they broke or why they work that way and yeah maybe we'll leave like the whole decision about should you attach clients - or files after they're so first problem was domain controller do I go the azure ad DES route or do I put another server up in Azure that's just a server 20:16 I think summer 2019 is out there standing up as no other domain controller into domain replication from unpress us to the cloud yep well I might ask myself another question first so is your customer going to have more than 128 connections at any given time like are there more than 128 clients that need to connect to this file share and that would be a no we're like this is like 10 or 12 all right 10 or 12 users connecting occasionally because most of the time they're in the office which also brought up that as your file sync could come into this at some point in time they want to be able to connect to the cloud as their backup option gosh they're not in the office something like when this whole last month happened and all of a sudden nobody can get to their file shares unless they're in the office because they have no VPN got you got you all right so that makes more sense that's all good and once we get through this whole thing I might spend it on you and and ask you why you didn't come another way with it because I'm I'm coming up with some other ideas as we talk through it we'll see that's that's good cuz I could use some I always like more ideas all right so so connections we aren't a problem so we need a VPN and we know we're going to be under the limits for point to site VPNs and and standing all that so we're good there so we know we're gonna need AV net and we're at least going to need a VPN to connect to and now like you said we need to figure out what domain or directory service are we going to leverage are we going to leverage a sure Active Directory domain services which is a DDS but it's a projection of you're a sure ad into a pair of managed domain controllers so DC's that you don't RDP into but you do have access to hook up with things like you know a doc and all your tooling that you use today to manage Active Directory so that's one path you can go down so don't pay for servers but pay for the service and the projection and the resiliency and SLA and everything comes with that or stand up your a manager yep which standing up and manage you know it's definitely cheaper I think I looked at as you're a DTS and they think it starts around a hundred and forty dollars a month it's a set fixed price because obviously this isn't a service that you can spin up and spin down it's just always running so it starts at 140 and goes up from there based on I can't even remember I think it was based on number of users and there's some functionality that's included in different levels but it's not cheap considering you can stand up a whole server for like 50 or 60 bucks and AD is not a process intensive service on a Windows server but you are left with managing the windows server and you don't necessarily have a che well you do have a che so they are redundant pairs well not if used in a DS not if you've been up it's not right yeah so if you do a DDS it is a redundant pair but if you do your own server then it's on you to figure all that out and then come up with your resiliency model are you going to use single instance VMs with premium discs to get some type of SLA at least at the VM level are you going to do availability sets are you gonna do zones what does that look like and how many do you actually need yep exactly and then you're doing all your own patching and server management if that server caches and all that you're living in is land you're her shrimp so I asked about and then I was talking to you a little bit the other day and I said okay so what does that migration path look like let's say I have a be on prom I want to go all cloud only so I'm doing ATM Prem hybrid with Azure ad de Cinco my users up but now I'm getting rid of all my on Prem servers so maybe I just want to go as your a DD s and D provision my on Prem ad is that a migration path or what does that look like to go cloud only with Azure ad and Azure ad D s and then D provision that hybrid Azure ad connect service and my own prime ad server yes it doesn't eliminate the VPN problem and having to connect to the dcs because you have that client authentication issue to get over right and you still need your VPN for your port 445 yep going into another topic so there's no way to get around this VPN issue you do so all that stuff stays really what you've done is you've shifted your at that point you've shifted your DC's from on-prem to Azure just inside of high-ass but you've still got the hookups and the connectivity and all the other things that come in so I'd be worried about a couple things in there in general by saying my DCs are only going to live on the cloud since you said your users are theoretically in normal times in the office the majority of the time I would want them talking to you the most network close authentication service that they could and then you know maybe if they were going into something like Windows virtual desktop or something like that up in Azure then okay there's your kind of file share and you're all set and ready to go and you've got your DC's your DC's up Nasher but if you really wanted to get rid of them you would do ad connect so you would do your hybrid identity and do all your projections from on-prem to ad and you could configure a DDS at any point in here because that's just a projection from your azure ad and then once all your identities are there and all the things that you need to do because all ad connect is gonna do is synchronize users groups and kind of some limited in the grand scheme of things metadata up it's not synchronizing your computers that are showing to the domain so that's a whole other issue that you have to solve but you could take a ad connect and then you know once everything's up their users and groups just rip ad Connect down get everything all the synchronization going to the new domain rejoin all the computers to the new domain that lives up in Azure because they've got to get back in there right you're probably still gonna want to manage them with GPOs and and things like that so all that gets in place and then stand down the on-prem DC's no I think one of the issues there is a DDS was not a real replica of your on-prem domain so it's it's not all the same FISMA role and everything else if you don't catch everything there's potential that you leave something behind you'd almost want like if this is really for back up maybe a redundant pair of read-only DCs or something like that up in Azure that are ready to go that somebody could hook up to you through that VPN on a point to site perspective and they'd authenticate to the most network close DC or if they were on Prem they'd still be able to authenticate to the one that's there best of both worlds maybe yeah so it's not really a migration from 80 to 80 TS it's more of a let's go have all three of them running and then let's just remove one and make sure that you manually copy the rebuilt did everything in Azure ad D s that you had on your in your on-prem yes sir you've just got to be very cognizant of the limitations of a DTS as a projection from a sure ad it's not the same exact type of thing so yes it lets you join computers and servers to the main yes it has GPIOs but it doesn't have all the functionality that you're gonna get in your on-prem ad and is and especially when I think about client management you're probably doing gpo's that rely on things like a DMX templates maybe you're managing office client installs or I'm sorry Microsoft 365 apps for enterprise because you haven't moved I just wanted to say that I was trying to figure out how to get you to say that this upset yeah I just say it twice this week in a presentation and it feels really dirty okay with just Office ProPlus people that's a moment it is but you still have management that you need to do there so then do you look downstream of saying well do I move over to cloud policy or some other type of service which you know arguably arguably even up into probably right there's all these options out there but all you wanted was a file share and now all of a sudden you have this technical implementation and the spread of things that operationally is turning into a little bit of a nightmare who's gonna maintain all this stuff and keep it patched and up-to-date and ready to go and right all the guides for what do we do when the VPNs down and everything else that comes along the way you know so that's kind of a DTS I think when you weigh the two out in a lot of scenarios a DDS has a place it's quite often the path of least resistance when I think about like friction and time to implementation to just stand up new DC's as you said they're often cheaper to run they can run on lower cost Hardware and lower cost VM sizes you might want to upsize them while you're kind of configuring everything the first time and then scale them down a little bit later once everything is up and running but it tends to be a known path where a DDS can still have some pain points especially if you haven't worked with it before and you haven't really taken the time to dig through all the documentation and the FA hues and things like that yeah I feel like going through all of this as I was digging around with it and playing with it a BDS serves a purpose a lot more when you're gonna keep all your existing on-prem domain controllers and as you're a DDS is simply a way to extend your Active Directory to the cloud in order to do just LDAP authentication against a cloud service without standing up a nother VM in the cloud yep that seems to be what I'm seeing I've actually used it I've seen it used in some creative ways and I had a customer that we ended up going down the advs path for just based on how they were set up so they were a customer who had a number of disconnected domains on Prem that didn't have trusts or anything like that in place so they couldn't cast and up ad Connect once and have everything routing through from all these domains user at contoso user at fabric am all those kinds of things into AD at the same time but relying on some of that functionality that you have where you can do the disconnected domain sync now and you can bring all those disparate domains for those MA scenarios into Azure ad and what they were able to do was they real to take six different disparate domains and user namespaces you know all those use your UPN's get them all sinking into Azure ad which was something they didn't have access to they couldn't put them all in the same resource domain or user domain are things on Prem and then they were running all a lot of their shared services in Azure so every server that they stood up in Azure was joined to that a DDS instance it wasn't joined back to company ones ad or company to use ad or company threes and that way if I was a user from company one or company three or company five I could login to the servers and Azure to do operations and management and run my applications and I was able to authenticate through and do all the things that I needed to do because servers still need like it's classic auth you know Kerberos TLM and all that good stuff there are use cases for it I think you just need to understand what your use cases are if you're just looking at a EDS and saying alright this is gonna be a rip and replace replacement for my existing domain services quite often I don't think that's exactly the case today give it time and it'll probably get there it's just not there today and we don't currently know when it'll get there because it has been a slow deployment or rollout it has some quirks to it I've seen I've seen a EDG has deployments where you go when you stand it up the first time and you go to do your sync and it doesn't matter if you have five users in your Azure ad or you have 25,000 you'll just hit the sync button and you might come back like 48 hours later and it hasn't started sinking yet and then you go oh what do i do how do I fix that the answer is you don't you call support and hang on the phone and wait a long time interesting alright so you go down that path and I think you weigh the two out you probably look at DC's yep and that's kind of as I've played with it looked at it and as we talked about it the other day and even based on what I'd seen you have pretty much convinced me that if we go down this route that is the way to go in this particular case which led to question two but they time we should probably do question two next time or should we keep going and have a really long episode let's keep going it's corona times okay yet nobody is listening nobody's driving anywhere listen to the podcast our numbers have actually dropped it's kind of interesting and I've seen that side tangent kind of across the board I'm in a few different podcast groups and all of that and people are saying overall podcast numbers seem to have declined because nobody's commuting anymore and that's what everybody listen to podcasts yeah I'm finding as a pod Cabot podcast listener I mean I subscribe to a lot of podcasts and listen to a lot of things I'm just falling behind it's the the drain of the times that catches up with you so where I might have gone and been done with work and just tried to decompress for 30 minutes now it's turned into kids are at home after everybody's at home things are going on and you know all of a sudden and there's that other zoom-in fight for you know like a happy hour and you haven't talked to people in weeks cuz you're quarantined and you're like I got to get like you know your self isolating or whatever it is you know you just have all these other competing things going on yeah and I am falling behind on all sorts of things which I intend to listen to at some point it's just gonna take me a while to get there yep outlook add-ins are a great way to improve productivity and save time in the workplace and sperry software has all the add-ons you'll ever need the save as PDF add-in is a best-seller and is great for project backups legal discovery and more this Annan saves the email and attachments as PDF files it's easy to download easy to install and sperry software's unparalleled customer service is always ready to help download a free trial at Sperry software comm SPER ry SOF TW ar e comm and see for yourself how great save as PDF is listeners can get 20% off their order today by entering the code cloud IT that's cloud IT CL o UD IT all one word at check out Sperry software worth in email not on email okay so after that side topic after that brief commercial on podcast listener ship tip bit of random information so let's just say for argument's sake we've decided we're gonna put our DC in the cloud a sure it's a server we're doing is we're gonna stand up a brand new domain controller up there now I have all my machines that are still on Prem and I am going to again for argument's sake because we're running to this whole cloud only model we are going to eventually will replicate 84 now but eventually that on-premise domain controller is going to get depreciate it removed so our only domain controller is going to be in the cloud but I still want to be able to join machines to it I still need to authenticate against it for something like as your file shares in the scenario we talked about now I have a whole nother set of problems or challenges and won't call them problems challenges or things to think about because I have to be able to connect to it to go into my computer my settings joined domain and then actually reach out to that domain controller especially in the case which my own tenant is in this case where I want in my domain to sync up to edge raid Eve properly so my UPN suffix is intelligent comm which is also my website which also has public dns records so DNS resolution can be a little challenging because I need intelligent comm to resolve to my internal domain controllers as well as to my external domain controllers if I want to hit my website and all of that going over this VPN connection to hit my DC yes did that make sense it does basically if you want to be able to authenticate to the DC you have to be hooked up to the network and that means you need all the routing and name resolution and other things in place yes so I am part way through that I think I might have it figured out but we had to record a podcast so I'll go back to it today but essentially same type of thing I'm using the same VPN gateway because I needed that VPN gateway anyways for my editor file shares over SMB and what I was struggling with last night was to get all of my DNS settings set up properly so I could join a Windows 10 machine that's running as a VM on my laptop connected over VPN to join this domain controller sitting up an azure and leverage the DNS and Adger so that I actually hit that instead of going out and trying to hit my public website when I tried to join the domain so my DC up there has oh and to top this all off don't ask the story behind this I have two virtual networks that I have peered an azure ad and my domain controller sits in one virtual network in my VPN gateways that's in another virtual network so I'm connecting to VPN connecting to the virtual network and ashur going over the peering connection between one virtual network to the other virtual network in order to hit my domain controller sitting in said know what so you got a hub spoke because I like to make things complicated you're trying to make your 12 person entity the largest enterprise in the world well this is just my personal this is a one-person entity this is me right now you and all the voices in your head that told you this would be a good idea to go down this path yeah some interesting things start to happen along the way there I think as you discovered particularly with name resolution when you have a V net in a sure there's kind of three DNS models that you can go with you can do a sure provided DNS which gives you resolution within the V net itself so I stand up VM 1 and VM 2 and I can ping VM 1 and VM 2 and they'll resolve by name and all those kinds of things I can do nslookup sand and see them and you know I can actually pull their private IPs and I'm all good sometimes you don't want to do that and you want to do bring your own DNS so you do BYO DNS and you take your V net and you set your V net settings to say no this is my DNS server that way when clients queer the V net for DNS it's going to point them back to your domain controller and you go like oh why are we doing this V net level because remember that's where all your network configuration is driven from you really don't make changes to the nicks on VMs and a sure you make changes to the configuration of the virtual neck outside and then that's projected down to your virtual machine or your virtual machine gets its configuration from there so you've got to have that resolution and to n so peering is kind of interesting because you've also got peering with a VPN gateway so you now you need to allow Gateway transit on one end but not the other end and you need to make sure that your potential routing and things are in place you might need you DRS at some point depending on how else do you want to shift traffic around in there you get all that up and running I bet your primary V net you were going in and saying like oh this is great I'm going to set it to my custom DNS and if you stood up VM one next to DC one they would totally resolve and they do what they need to do but you introduced that V net peer which yeah which then makes resolution a little bit weirder because your client so you're hooked up on that point to site VPN or side to site whatever you're using yep so your client now where is it pulling its dns from it's pulling its dns from from the same v net as the VPN gateway which most of us I think would just leave into ash or provided DNS by default because it's just a hub right it's sitting there doing what it needs to do let it do it which is what I do you know you might see the VM on the other side but it's gonna resolve as the internal name with the cloud app that net and all that and not as the proper NetBIOS name that you're gonna need to join the to join the network so probably some more configuration to do where now you take the peer network and the peer network that or the hub rather is also needs to have its dns configuration updated so that it pulls its dns from the DC over in the spoke yeah yeah and that was the hint that we found for anybody that finds themselves in a wonky scenario such as myself I was going out and pinging it and I was like well when I do and I look up and I'm looking for my domain controller it's coming back with this internal cloud app dot net not my domain and you were like I bet your DNS is wonky in that V net that you have your gateway in and lo and behold it was yep so that's one option is go down that path the other option is you know if you're just doing this for POC you can't use a host file because of the holes SRV record thing the serve records but you can use an LM host file to go ahead and point to your DC's it's a pain in the proverbial rear-end to set it up but you can do it I think the other thing to think about is identity is really a core service it's typically maybe when you just look at kind of your topological design and you're thinking about how to approach that with your customer your identity your firewall your logging and management those are all core services writers or shared services they're not really application are kind of segment specific so something like your DC may not actually be living in a spoke in your final configuration it might be closer in the hub anyway which will make things a little bit easier yes in theory had I done this properly and I didn't already have some of these V Mets configured and I was paying attention to what I was doing at 2:00 a.m. the other night I would have just put my gateway in the same V net with my domain controller instead of in a separate one and at this point in time now it's just can I actually do this realistically I should probably just go delete my gateway and go stand it up in my other V net and save myself some hours but again I get into this and I look at this as learning and figuring this out and how does this all work together and can I get it to work that necessarily is this the way I should do it absolutely I'm not saying you shouldn't surprise things out yes but I've wholeheartedly agree with you I just want to make sure we have the conversation in case somebody actually does head up listening to this and they go oh those people are going down some crazy path or somebody looks at it and they're like hey they sound like they know what they're talking about maybe I should go that and I always like to talk about the other ways you have to don't do it the way I did it unless you have a very specific reason other than it was 2:00 a.m. and I created my gateway the wrong and I wanted to experiment with this all right so DC up client connects and VPNs they're theoretically you can just hook up to files now theoretically I think oh so as your files now gets really weird should I talk about as your files in the security there absolutely so as they rolled all this out now we can connect we're gonna assume that you can so first thing you should do with Azure files is once you get all of this to figure it out go connect with the storage account in the key to make sure you can actually connect that your routing is going properly because at this point in time assuming you're connected to VPN you have your network setup right download the VPN client to this is another thing there's a VPN client that doesn't executable that go sets up the whole network in the routing and everything that your Windows 10 machines don't touch that until your network is all configured because what that executable is doing is downloading a configuration file making a bunch of changes if you change your network your VPN client doesn't get that change and you actually have to just disconnect remove that VPN connection go download it again go set it up again and get all those network changes so we're going to assume all that took place I can connect with a storage account name and key but now I want to connect using my username instead of that storage account key so I can leverage all the normal NTFS file permissions and permission folders in the sizer file share differently and all of that stuff so first the Machine you do all this from has to be domain joined and there's some certain powershell scripts you have to go run to actually set up your file your file share in asher to be able to authenticate against ad and those do have to be run from a domain controller so you go run those scripts now you're at your files are set to authenticate with an ad server and there are a couple levels of permissions that you need a set and the documentation does walk through all this but you have to set the are back permissions on the file share itself there are three permissions in our back for SMB specifically an SMB I think it's an SMB file reader an SMB File contributor and an SMB it's like it's not advanced contributor it's something else but it's another level up from contributor so the first thing you have to do is go in set these our back permissions this is gonna look against Azure ad for these are back permissions which is why you have to have everything synchronized together that does not give you access to the file shares that just gives you that our back permission to leverage the azure service now you can go mount it again with that primary key and your storage account name and then right click in Windows and go into the properties in security and then start setting the security and the shares and the folders and the files looking back against your domain controller so there's both of those permissions that have to be set and then once all of that is done assuming whatever client you're connecting to came connect to both Azure ad in to your domain controller you can go in and do a typical net use point it to the azure file share you can do it /you and throw in your UPN from Azure ad or you can just do the net use and it all prompt you for a username the password type all that in in in theory you have a map to network drive that's using your typical permissions coming from a domain controller in theory in theory again taking all those prerequisites and everything we just talked about being configured perfectly for that to even work yes yes and there you have it and there was something else I had to do and I'm gonna I'd have to dig through it but I did also have to create a private endpoint for my as your files and I can't remember at what point time I hit that and why I had to do that why would you want the oh why because it's a private endpoint that points to a private IP for my yeah maybe I didn't need this this may have been one of my testings when I was trying to play with everything I don't think I actually need this so I don't think you would off the top of my head you could connect across the public endpoint and do things that way the private endpoint would arguably be more secure for you especially because your VPN again that way your VP anning in and when they go to connect to the file share they're actually connecting through the private endpoint and their routing straight into the storage service and even though the public fqdn is still there nobody can connect to it that way they can only come through the private end point I think this was when all of my testing was going on to try to figure out how all these configurations worked I think I created this and yeah as we're talking about it looking at it I don't think I actually need it anymore Hey look you simplified things while making it simplify things or get rid of a private endpoint connected to a storage account yes that in theory would all work and that would provide you a way to actually be anywhere as long as you connect it to the VPN first you could go mount these file shares as a user instead of using that primary storage key and then one thing this client had talked about is they're like well when I'm on premises then can I speed up my connection because now inevitably you're going over the Internet you're connecting to a file share and if you're pulling 100 Meg 200 Meg files back and forth over a VPN connection to an extra file share it's not going to be merely a specially a point to site connection yes especially point to site connection it's not going to be nearly as quick so if you're just pulling it off your local server so then they were like well can we do like the azure file sync so we can have a cached copy locally in the office and use this as kind of a back emergency option if we want to get to those files from externally and also it if you're doing at your file sync it does give you some of that DR type scenario where our office catches fire we lose our server and now we again we have this backup option we have all of our files up and as your files where we can get to them restore them do all that if the need arises it would be there and it would all be very nifty lots of moving parts yes that is the biggest thing I took away from this is this is not me I come from the office 365 said this is not stand-up an azure or a SharePoint site and do a sync there's a lot of moving parts a lot of routing a lot of networking there's a lot of stuff to figure out and take into consideration if you want to go this route so you said you had one other thing too that you were gonna throw out there is why didn't you just do this what is your thoughts on this whole configuration setup other than share points a lot easier SharePoint would have been easier you should have just convinced him to go that way and you know if SharePoint wasn't their thing there's lots of other file storage services out there like I don't know box or Dropbox or pick pick one of those file yeah yeah if files is your thing and per user authentication is your thing and you want it to be resilient and live in the cloud here you go there's the right tool for the right job right we had an episode a while back about that about yeah picking the right tools specifically when it comes to cloud storage yes so I think one of the other things to maybe think about is you're doing this as a one-off scenario and you're doing it for the time when those users need to be away from the office and kind of have that remote connectivity through I think another thing to think about would be what if you didn't have the VPN and you didn't have that whole client setup piece and maybe you didn't do a surefire you just went with a traditional set of DCs and a replicated file-share that lived in the cloud so say you did like DFS R or something like that over a site-to-site VPN connection from the office you know have your clients rather than coming across a VPN and dealing with that headache maybe just stand up like Windows virtual desktop or RDS services and something like that and have them connect to that service when they need to so ok you need to go to the cloud your remote here's your desktop in the cloud it can talk to all the things that you need to talk to without all those routing issues and everything else you've kind of run in to you along the way with ports and protocols because then it's just a 443 connection and anybody can do that and you'd have more control over sizing latency performance I think you'd have some better client controls there cuz you'd already have the DC's in Azure you'd still have a ad but it might let you even move away from Asscher files which you might not need in this scenario and just have like you said like a regular file share run it up there and maybe make it a little bit better leave that customer runs that file share on their DC say hey we're going - or we can make it better but you really don't need a pass service like we can live in Iyaz and it's a known quantity what if you just did Windows virtual desktop so same thing they're talking about Windows virtual desktop DC is sitting in a chore again now you're not dealing with VPN you're not dealing with network cuz you're all sitting on the internal Azure network and you just did as your file shares with Windows virtual desktop and a DC and Azure because like you said now you're not dealing with port 445 everything is in the same V net you don't have any routing issues you can join your weren't Windows virtual desktop to your domain as your file shares should work yep significantly easier and you could also go that route you're not gonna have the latency there because again you're going over all the internal networks at this point in time yeah yeah I mean it depends on how you're gonna use it right do you need that per user authentications probably the biggest thing in there and just based on a path you're going down with per user authentication and the way it is today being a preview you know but back to that psycho thing it might be easier to go with known quantity and say this is gonna be supported and ready to go especially I'd imagine you're looking at something like this for a customer because of the time that were in they're coming up with some specific needs based on what's going on today and we don't know how long what's going on today is gonna go on and sometimes that roadmap for ashore files is a little murky you might have some other options in there that potentially simplify things or maybe give you some other cost levers or controls yep and we did start going down that path or at least having some of those initial conversations about maybe you do leverage Windows virtual desktop for everything because at that point in time now every computer in the office is essentially just a thin client it's a terminal can even be an iPad with those nifty new keyboards and mice that are hopefully coming today via UPS and your office computer could just be pretty much anything at this point in time because you're just connecting to Windows virtual desktop and doing everything in the cloud I think it depends on how you look at it I was maybe thinking of it more as your file share scenario where it's a backup yep so maybe you have a limited size host pool but because it lives in Azure it can scale when it needs to so it's not a problem that it's only I forgot maybe one available desktop host sitting there because it's gonna be able to scale from 1 to 12 on demand as users are coming in and out versus having 12 or however many you need running all the time and then it truly is that back-up scenario yeah and that's kind of one of those key differentiators is I think this might start as a backup and then turn into maybe this is our everyday functionality or everyday scenario we'll just kind of have to see where this goes but it has been a very interesting exercise on my part to figure all this yeah so he's fun to play with new stuff welcome to Azure yes thanks I've actually been doing a little bit more as your stuff I have a couple other projects that are tied all into Azure I as spring moving back to my routes as a system admin and dealing with servers and racks only some of its a little bit more abstract now it's all just in a JSON file someplace yes I did not have like these predefined as your DNS things before to figure out crazy VPN routes and v-net peering yeah but now you've done it and it can't work over up here you'll never forget that's the theory that's the hope the plan all that all right well thanks for this extended episode yeah no thank you it was fun it was and we have lots more stuff that we can talk about we actually have like three or four topics today so we've got lots more fun stuff coming in the future so go enjoy your cloudy day while you sit inside in social isolation don't work too hard go take a walk in the beach have you gotten out there yet have you got out taking a walk on the beach I have not gone to the beach yet it's been a week we're going out on the boat this weekend so that's the plan nice that sounds nice it relaxes yep all right man well until next week all right enjoy [Music] if you enjoyed the podcast don't leave us a 5-star rating in iTunes it helps to get the word out so more IT pros can learn about office 365 and Azure if you have any questions you want us to address on the show or feedback about the show feel free to reach out via our website Twitter or Facebook thanks again for listening and have a great day 